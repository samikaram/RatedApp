            <div class="patient-cards-container" style="height: 100%; display: flex; flex-direction: column;">
                
                <!-- Patient Search Form - Compact (40px) -->
                <div style="display: flex; gap: 5px; margin-bottom: 10px; align-items: flex-start;">
                <div class="patient-search-section" style="margin-top: -15px; width: 66.67%; flex-shrink: 0; margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="patient-search-input" placeholder="Search by name or ID..." 
                               style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;" onkeypress="if(event.key==='Enter'){searchPatients();}">
                        <button type="button" id="search-patient-btn" onclick="searchPatients()" 
                                style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">
                            Search
                        </button>
                    </div>

                    <!-- Calculate Button - Same size as Search, positioned under it -->
                    <!-- Calculate Button Container - Aligned under Search Button -->
                    <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
                    <button type="button" id="calculate-btn" onclick="calculatePatientScores()"
                            style="padding: 8px 9px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;" disabled>
                        Calculate
                    </button>
                    </div>
                

                    <div class="search-results-section" style="width: calc(100% - 88px); flex-shrink: 0; max-height: 120px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 4px; display: none;" id="search-results-container">
                    <div class="search-results-header" style="padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 600; font-size: 0.85rem;">
                        Search Results (<span id="results-count">0</span> found)
                    </div>
                    <div class="search-results-list" id="search-results-list" style="max-height: 80px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                </div>
                <!-- Score & Rating Container -->
                <div class="score-rating-container" style="flex: 1; flex-shrink: 0; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9; display: flex; flex-direction: column; justify-content: flex-start; align-items: center;; margin-top: -15px;">
                <!-- Header -->
                <div style="font-size: 0.9rem; color: #000; margin-bottom: 5px;">üìà Score & Rating</div>
                
                <!-- Score Display -->
                <div id="patient-score-display" style="font-size: 1.35rem; font-weight: bold; color: #007bff; margin-bottom: 2px;">---/--</div>
                
                <!-- Rating Display -->
                
            </div>
                </div>
                
                <!-- Search Results - Scrollable (120px max) -->
                
                
                <!-- PLACEHOLDER FOR NEXT STAGES -->
                <!-- Selected Patient Header - Compact (30px) -->
                <div class="selected-patient-header" style="flex-shrink: 0; padding: 8px 12px; background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; margin-bottom: 10px; display: none;" id="selected-patient-header">
                    <div style="position: relative; width: 100%; height: 24px;">
                        <span style="font-weight: 600; font-size: 0.9rem;" id="selected-patient-name">No patient selected</span>
                        <span style="font-size: 0.8rem; color: #666;" id="selected-patient-id">ID: -</span>
                    </div>
                </div>
                
                <!-- Behavior Cards - Scrollable Main Content -->
                <div class="behavior-cards-section" style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 10px; display: none;" id="behavior-cards-container">
                    
                    <!-- Likability Slider - Compact (35px) -->
                    <!-- Open DNA Invoice - Compact Display Only (35px) -->
                    <!-- Unpaid Invoices - Compact Display Only (35px) -->
                    <!-- DNA - Did Not Arrive - Compact Display Only (35px) -->
                    <!-- Cancellations - Compact Display Only (35px) -->
                    <!-- Referrer Score - Compact Display Only (35px) -->
                    <!-- Consecutive Attendance - Compact Display Only (35px) -->
                    <!-- Yearly Spend - Compact Display Only (35px) -->
                    <!-- Age Demographics - Compact Display Only (35px) -->
                    <!-- Future Appointments - Compact Display Only (35px) -->
                    <div class="compact-behavior-card" id="future-appointments-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #28a745;">üìÖ Future Appointment</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 upcoming</span>
        </div>
        <span id="future-appointments-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #28a745; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="age-demographics-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #28a745;">üë§ Age Demographics</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">Age bracket</span>
        </div>
        <span id="age-demographics-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #28a745; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="yearly-spend-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #28a745;">üí∞ Yearly Spend</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">$0 spent</span>
        </div>
        <span id="yearly-spend-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #28a745; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="consecutive-attendance-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #28a745;">‚úÖ Consecutive Attendance</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 consecutive</span>
        </div>
        <span id="consecutive-attendance-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #28a745; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="referrer-score-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #28a745;">üë• Referrer Score</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 referrals</span>
        </div>
        <span id="referrer-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #28a745; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="cancellations-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #dc3545;">‚ùå Cancellations</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 cancellations</span>
        </div>
        <span id="cancellations-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #dc3545; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="dna-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #dc3545;">üö´ DNA - Did Not Arrive</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 DNA appointments</span>
        </div>
        <span id="dna-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #dc3545; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="unpaid-invoices-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #dc3545;">üí∏ Unpaid Invoices</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 unpaid invoices</span>
        </div>
        <span id="unpaid-invoices-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #dc3545; font-weight: 600;">0</span>
    </div>
</div>

                    <div class="compact-behavior-card" id="open-dna-invoices-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
    <div style="position: relative; width: 100%; height: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; position: relative;">
            <span style="font-weight: 600; font-size: 0.85rem; color: #dc3545;">üìã Open DNA Invoices</span>
            <span style="font-size: 0.75rem; color: #666; position: absolute; left: 50%; transform: translateX(-50%);">0 open DNA invoices</span>
        </div>
        <span id="open-dna-score" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; color: #dc3545; font-weight: 600;">0</span>
    </div>
</div>
                    
<div class="compact-behavior-card" id="likability-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
<div style="position: relative; width: 100%; height: 24px;">
<div style="display: flex; align-items: center; gap: 24px;">
<span style="font-weight: 600; font-size: 0.85rem; color: #27ae60;">üòä Likability</span>

<!-- RESPONSIVE SLIDER AREA -->
<div class="likability-slider-container" style="flex: 1; position: relative; margin: 0 8px; max-width: 300px; min-width: 150px; height: 6px; align-self: flex-start;">
<div class="neutral-mark" style="position: absolute; left: 50%; top: calc(50% + 9px); transform: translate(-50%, -50%); width: 2px; height: 12px; background: #666; z-index: 2; pointer-events: none;"></div>
<input type="range" id="likability-slider" min="-100" max="100" value="0" style="width: 100%; height: 6px; position: relative; z-index: 1;" disabled>
</div>

<button type="button" id="edit-likability-btn" onclick="editLikability()" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer; flex-shrink: 0; white-space: nowrap; margin-right: 60px;">Edit</button>

<button type="button" id="save-likability-btn" onclick="saveLikability()" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer; display: none;">Save</button>

<span id="likability-value" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); min-width: 45px; text-align: center; font-size: 0.8rem; font-weight: 600;">0</span>
</div>
</div>
</div>
                    
                    
                    <!-- Additional Behavior Cards Placeholder -->
                    <div class="additional-behaviors" id="additional-behaviors-container">
                        <p style="text-align: center; color: #666; font-size: 0.85rem; margin: 20px 0;">
                            Additional behavior cards will be added in Stage 2
                        </p>
                    </div>
                    
                </div>
                
            </div>
        </div>
    </div>
<script>

// Global flag to prevent form submission during delete operations
window.deleteOperationInProgress = false;

// Store button reference globally for reliable access
let currentAddButton = null;

// Show success message if page was loaded after form submission

function updateSliderValue(sliderId, value) {
    document.getElementById(sliderId + "_value").textContent = value;
}

function handleFormSubmit(event) {
    console.log('üö® handleFormSubmit() called - checking what triggered this');
    console.log('üìä CALL STACK TRACE:');
    console.trace('handleFormSubmit() call stack');
    // Prevent form submission during delete operations
    if (window.deleteOperationInProgress) {
        console.log('Form submission blocked - delete operation in progress');
        return false;
    }

    event.preventDefault();
    const form = document.querySelector('form[method="get"]');
    
    // Sync current screen data to hidden fields before submission
    console.log("üîÑ Syncing bracket data before form submission");
    updateAgeBracketsData();
    updateSpendBracketsData();
    console.log("‚úÖ Bracket data synced successfully");

    const formData = new FormData(form);
    
    // Ensure CSRF token is included
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.set('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Only add preset_id and apply_preset action if this is an Apply Preset call
    // Check if this form submission is from Apply Preset by looking for a global flag
    if (window.applyPresetInProgress && window.selectedPresetValue) {
        formData.append('preset_id', window.selectedPresetValue);
        formData.append('action', 'apply_preset');
        console.log('Apply Preset: Added preset_id and action to form data');
    }
    
    
    // Add action parameter for regular Update Weights button
    if (!window.applyPresetInProgress) {
        formData.append("action", "update_weights");
        console.log("Update Weights: Added action=update_weights to form data");
    }
    // DEBUG: Show what Apply button sends to Django
    console.log("üîç APPLY BUTTON DEBUG - FormData contents:");
    console.log(Array.from(formData.entries()));
    console.log("üîç Does Apply button send action parameter?", formData.get('action'));
    
    fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": csrfToken || form.querySelector('[name=csrfmiddlewaretoken]')?.value,
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.style.display = "block";
                setTimeout(() => saveMessage.style.display = "none", 1000);
            }

            // Update accordion header (if needed)
            const accordionTitle = document.querySelector('.accordion-title');
            if (accordionTitle) {
                console.log('üö® SETTING WEIGHTS UPDATED - triggered by handleFormSubmit()');
                accordionTitle.innerHTML = '‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>Weights Updated</strong>';
            }
        }
    })
    .catch(error => {
        console.error("AJAX Error:", error);
        alert("Error submitting form. Please try again.");
    });
    return false;
}


// üõ°Ô∏è BULLETPROOF BRACKET PARSING FUNCTION
function safeParseBracket(element, type = 'bracket') {
    // Safety check: element exists and has proper structure
    if (!element?.children?.[0]?.children?.[0] || !element?.children?.[0]?.children?.[1]) {
        console.warn(`‚ö†Ô∏è Invalid ${type} structure:`, element);
        return null;
    }
    
    const rangeText = element.children[0].children[0].textContent?.trim();
    const percentText = element.children[0].children[1].textContent?.trim();
    
    // Validate extracted data
    if (!rangeText || !percentText) {
        console.warn(`‚ö†Ô∏è Missing ${type} data:`, {rangeText, percentText});
        return null;
    }
    
    // Additional validation for percentage
    const percentage = parseInt(percentText.replace('%', ''));
    if (isNaN(percentage) || percentage < 0 || percentage > 100) {
        console.warn(`‚ö†Ô∏è Invalid ${type} percentage:`, percentText);
        return null;
    }
    
    return {
        rangeText: rangeText,
        percentText: percentText,
        percentage: percentage,
        element: element
    };
}

function deleteAgeBracket(bracketId) {
    if (confirm("Are you sure you want to delete this age bracket?")) {
        // Remove from DOM immediately - save to database when 'Update Preset' is pressed
        // Use event.target to get the clicked button directly (works for all bracket types)
        const button = event.target;
        if (button && button.parentElement && button.parentElement.parentElement) {
            button.parentElement.parentElement.remove();
            console.log('Removed age bracket from display (will save when Update Preset pressed)');
        }
    }

        
        // Bracket data sync removed - prevents triggering 'Weights Updated'
    }// Prevent double-clicks
function addNewAgeBracket(event) {
    // CRITICAL FIX: Prevent form submission that triggers handleFormSubmit()
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    console.log("üîç addNewAgeBracket() called - should NOT trigger Weights Updated");
    console.log("DEBUG: addNewAgeBracket function called!");
    
    const addButton = document.querySelector("button[onclick=\"addNewAgeBracket(event)\"]");
    if (!addButton) {        console.error("Add button not found!");
        return;
    }
    
    // Store button reference globally for reliable access
    currentAddButton = addButton;
    // Store original onclick for restoration
    window.originalAgeButtonOnclick = addButton.onclick;
    
    // Create input form
    const newBracketForm = document.createElement("div");
    newBracketForm.id = "new-bracket-form";
    newBracketForm.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 4px; padding: 8px; border: 1px solid #007bff; border-radius: 3px; background: #f8f9fa; font-size: 0.8rem;">
            <div style="display: flex; gap: 4px; align-items: center;">
                <input type="number" id="new_min_age" placeholder="Min" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="120">
                <span>-</span>
                <input type="number" id="new_max_age" placeholder="Max" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="999">
                <input type="number" id="new_percentage" placeholder="%" style="width: 40px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="100">
            </div>
            <div style="display: flex; gap: 4px; margin-top: 2px;">
                <button onclick="cancelNewAgeBracket()" style="background: #adb5bd; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Cancel</button>
            </div>
        </div>
    `;
    
    // Replace add button with input form
    addButton.parentElement.insertBefore(newBracketForm, addButton);
    addButton.textContent = "SAVE";
    
    // Change button onclick to save function
    addButton.onclick = function() { saveNewAgeBracket(); };
    
    // Focus on first input
    document.getElementById("new_min_age").focus();

        
        // Bracket data sync removed - prevents triggering 'Weights Updated'
    }
function saveNewAgeBracket() {
    console.log("DEBUG: saveNewAgeBracket function called!");
    
    // Get form values
    const minAge = document.getElementById("new_min_age").value;
    const maxAge = document.getElementById("new_max_age").value || "";
    const percentage = document.getElementById("new_percentage").value;
    
    // Validation
    if (!minAge || !percentage) {
        alert("Please fill in all required fields");
        return;
    }
    
    // Validate percentage range
    if (percentage < 0 || percentage > 100) {
        alert("Percentage must be between 0 and 100");
        return;
    }
    
    // Create bracket element for display (screen-only)
    const ageBracketsContainer = document.getElementById("age-brackets-list");
    if (ageBracketsContainer) {
        // Create the new bracket element
        const newBracketDiv = document.createElement("div");
        newBracketDiv.style.cssText = "display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 8px;";
        
        const bracketContent = document.createElement("div");
        bracketContent.style.cssText = "display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;";
        
        const rangeDiv = document.createElement("div");
        rangeDiv.style.cssText = "padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 60px; text-align: center;";
        rangeDiv.textContent = (maxAge === "" || !maxAge) ? minAge + "+" : minAge + "-" + maxAge;
        
        const percentDiv = document.createElement("div");
        percentDiv.style.cssText = "padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #333; min-width: 50px; text-align: center;";
        percentDiv.textContent = percentage + "%";
        
        const deleteButtonDiv = document.createElement("div");
        deleteButtonDiv.style.cssText = "display: flex; gap: 4px; margin-top: 2px;";
        
        const deleteButton = document.createElement("button");
        deleteButton.style.cssText = "background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;";
        deleteButton.textContent = "Delete";
        deleteButton.onclick = function() { 
            newBracketDiv.remove(); 
            console.log("Age bracket removed from display");
        };
        
        // Assemble the bracket
        bracketContent.appendChild(rangeDiv);
        bracketContent.appendChild(percentDiv);
        deleteButtonDiv.appendChild(deleteButton);
        newBracketDiv.appendChild(bracketContent);
        newBracketDiv.appendChild(deleteButtonDiv);
        
        // Add to container
        ageBracketsContainer.appendChild(newBracketDiv);
        
        console.log("Age bracket added to display:", rangeDiv.textContent, percentDiv.textContent);
    }
    
    // Clear form inputs
    document.getElementById("new_min_age").value = "";
    document.getElementById("new_max_age").value = "";
    document.getElementById("new_percentage").value = "";
    
    // Remove the input form
    const inputForm = document.querySelector('div[style*="border: 1px solid #007bff"]');
    if (inputForm) {
        inputForm.remove();
    }
    
    // Reset ADD button
    const addButton = document.querySelector('button[onclick*="addNewAgeBracket"]');
    if (addButton) {
        addButton.textContent = "+ ADD";
        addButton.style.background = "#28a745";
        addButton.onclick = function() { addNewAgeBracket(); };
    }
    
    console.log("Age bracket save complete - screen only, no backend call");
}

function cancelNewAgeBracket() {
    // Remove input form
    const form = document.getElementById("new-bracket-form");
    if (form) {
        form.remove();
    }
    
    // Reset ADD button
    if (currentAddButton) {
        currentAddButton.textContent = "+ ADD";
        currentAddButton.style.background = "#28a745";
        currentAddButton.onclick = function() { addNewAgeBracket(); };
    }
    
    window.savingInProgress = false;
}
// Spend Bracket Functions
function deleteSpendBracket(bracketId) {
    if (confirm("Are you sure you want to delete this spend bracket?")) {
        // Remove from DOM immediately - save to database when 'Update Preset' is pressed
        // Use event.target to get the clicked button directly (works for all bracket types)
        const button = event.target;
        if (button && button.parentElement && button.parentElement.parentElement) {
            button.parentElement.parentElement.remove();
            console.log('Removed spend bracket from display (will save when Update Preset pressed)');
        }
    }

        
        // Bracket data sync removed - prevents triggering 'Weights Updated'
    }

// Preset Selection Helper Function
function getSelectedPresetId() {
    // Empty function first - test it exists
    const dropdown = document.getElementById('preset-dropdown');
    if (!dropdown) return null;
    // Validation: return null for empty or default selections
    const value = dropdown.value;
    if (!value || value === ''|| value.trim() === '') {
        return null;
    }
    return value;
}

function confirmPresetDeletion(presetName, isLastPreset) {
    // Protection: Cannot delete last remaining preset
    if (isLastPreset) {
        alert('Cannot delete the last remaining preset.');
        return false;
    }
    
    // Confirmation with preset name
    const message = 'Are you sure you want to delete the preset "' + presetName + '"?\n\nThis action cannot be undone.';
    return confirm(message);
}

function deletePreset() {
    // Set flag to prevent form submission during delete
    window.deleteOperationInProgress = true;
    console.log('Delete operation started - form submission blocked');

    try {
        console.log('Delete preset function called');
        // Step 3B: Get selected preset ID
        const presetId = getSelectedPresetId();
        if (!presetId) {
            console.error('No preset selected for deletion');
            return;
        }
        console.log('Selected preset ID for deletion:', presetId);

        // Step 3C: Get user confirmation for deletion
        const dropdown = document.getElementById('preset-dropdown');
        const presetName = dropdown.options[dropdown.selectedIndex].text;
        const isLastPreset = dropdown.options.length <= 1;
        
        const confirmed = confirmPresetDeletion(presetName, isLastPreset);
        if (!confirmed) {
            console.log('Preset deletion cancelled by user');
            return;
        }
        
        // STEP 1: Applied preset detection logic
        const currentAppliedPreset = document.querySelector('.accordion-title strong:last-of-type');
        const appliedPresetName = currentAppliedPreset ? currentAppliedPreset.textContent.trim() : '';
        const isDeletingAppliedPreset = (presetName === appliedPresetName);
        
        console.log('Preset to delete:', presetName);
        console.log('Currently applied preset:', appliedPresetName);
        console.log('Is deleting applied preset:', isDeletingAppliedPreset);
        console.log('User confirmed deletion, proceeding...')
        
        // STEP 2A: Second popup for applied preset deletion
        if (isDeletingAppliedPreset) {
            // Dynamic message based on backend fallback priority
            let fallbackMessage;
            if (presetName === 'Factory Settings') {
                fallbackMessage = 'You are deleting the currently applied preset "' + presetName + '".\n\nThe system will automatically revert to the next available preset to maintain functionality.\n\nProceed with deletion?';
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                fallbackMessage = 'You are deleting the currently applied preset "' + presetName + '".\n\nThe system will automatically revert to "Factory Settings" to maintain functionality.\n\nProceed with deletion?';
            }
            const secondConfirm = confirm(fallbackMessage);
            if (!secondConfirm) {
                console.log('Applied preset deletion cancelled at second popup');
                return;
            }
            console.log('Applied preset deletion confirmed at second popup');
        }

        // Step 3D: Send AJAX DELETE request to backend
        fetch("/patients/delete-preset/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "X-Requested-With": "XMLHttpRequest"
            },
            body: "action=delete_preset&preset_id=" + presetId
        })
        .then(response => response.json())
        .then(data => {
            console.log('AJAX response received:', data);
            console.log('DEBUG FRONTEND: data.was_active_preset_deleted =', data.was_active_preset_deleted);
            console.log('DEBUG FRONTEND: data.fallback_preset =', data.fallback_preset);
            if (data.fallback_preset) {
                console.log('DEBUG FRONTEND: fallback_preset.id =', data.fallback_preset.id);
                console.log('DEBUG FRONTEND: fallback_preset.name =', data.fallback_preset.name);
            }
            console.log('DEBUG FRONTEND: Current accordion header before update:', document.querySelector('.accordion-title').innerHTML);
            if (data.success) {
            
                console.log('Preset deleted successfully:', data);
                
                // STEP 2B: Show inline success message (replace alert)
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = '‚úÖ Success';
                    saveMessage.style.display = 'block';
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                        saveMessage.textContent = '‚úÖ Success'; // Reset to default
                    }, 3000);
                }
                
                // Remove deleted preset from dropdown
                const dropdown = document.getElementById('preset-dropdown');
                const deletedPresetId = presetId;
                
                // Find and remove the option
                for (let i = 0; i < dropdown.options.length; i++) {
                    if (dropdown.options[i].value === deletedPresetId) {
                        dropdown.remove(i);
                        console.log('Removed preset option:', deletedPresetId);
                        break;
                    }
                }
                
                // STEP 2C: Workflow branching based on applied preset detection
                if (isDeletingAppliedPreset) {
                    console.log('WORKFLOW 2: Applied preset deleted - updating header and values');
                    
                    // Handle fallback when active preset was deleted
                    if (data.was_active_preset_deleted && data.fallback_preset) {
                        console.log('Backend confirmed active preset deletion, switching to fallback:', data.fallback_preset.name);
                        
                        // Apply the fallback preset to update screen values
                        applyPresetById(data.fallback_preset.id, data.fallback_preset.name);
                        
                        // Update accordion header to show new active preset
                        // Update accordion header to show fallback preset (BOLD - new applied preset)
                        const accordionTitle = document.querySelector('.accordion-title');
                        if (accordionTitle && data.fallback_preset && data.fallback_preset.name) {
                            accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>${data.fallback_preset.name}</strong>`;
                            console.log('Accordion header updated to show fallback preset:', data.fallback_preset.name);
                        }
                        
                        // Select fallback preset in dropdown
                        for (let i = 0; i < dropdown.options.length; i++) {
                            if (dropdown.options[i].value === data.fallback_preset.id.toString()) {
                                dropdown.selectedIndex = i;
                                console.log('Selected fallback preset in dropdown:', data.fallback_preset.name);
                                break;
                            }
                        }
                        
                        // Auto-apply the fallback preset to load its values
                        console.log('Auto-applying fallback preset to maintain system functionality');
                        // Only auto-apply fallback if we deleted the active preset
                        if (data.was_active_preset_deleted && data.fallback_preset) {
                        }
                    }
                    
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.log('WORKFLOW 1: Non-applied preset deleted - no UI changes needed');
                    
                    // Handle dropdown selection after deletion (non-active preset deleted)
                    if (dropdown.options.length > 0) {
                        dropdown.selectedIndex = 0;  // Select first remaining preset
                        console.log('Selected first remaining preset');
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.log('No presets remaining in dropdown');
                        // Could add logic to create default preset or disable UI
                    }
                }
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.error('Backend error:', data.error || data.message);
                alert('Error: ' + (data.error || data.message || 'Failed to delete preset'));
            }
        })
        .catch(error => {
            console.error('AJAX error:', error);
            alert('Error deleting preset. Please try again.');
        });
    } catch (error) {
        console.error('Error in deletePreset:', error);
    }
    // Clear flag - delete operation complete
    window.deleteOperationInProgress = false;
    console.log('Delete operation completed - form submission re-enabled');

}

function addNewSpendBracket(event) {
    // CRITICAL FIX: Prevent form submission that triggers handleFormSubmit()
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    console.log("üîç addNewSpendBracket() called - should NOT trigger Weights Updated");
    console.log("DEBUG: addNewSpendBracket function called!");
    
    const addButton = document.querySelector('button[onclick="addNewSpendBracket(event)"]');
    if (!addButton) {
        console.error("Add button not found!");
        return;
    }
    
    // Store button reference globally for reliable access
    currentAddButton = addButton;    
    // Store original onclick for restoration
    window.originalSpendButtonOnclick = addButton.onclick;
    
    // Create input form
    const newBracketForm = document.createElement('div');
    newBracketForm.id = 'new-bracket-form';
    newBracketForm.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 4px; padding: 8px; border: 1px solid #007bff; border-radius: 3px; background: #f8f9fa; font-size: 0.8rem;">
            <div style="display: flex; gap: 4px; align-items: center;">
                <input type="number" id="new-spend-min" placeholder="Min $" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" step="0.01" min="0">
                <span>-</span>
                <input type="number" id="new-spend-max" placeholder="Max $" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" step="0.01" min="0">
                <input type="number" id="new-spend-percentage" placeholder="%" style="width: 40px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="100">
            </div>
            <div style="display: flex; gap: 4px; margin-top: 2px;">
                
                <button onclick="cancelNewSpendBracket()" style="background: #adb5bd; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Cancel</button>
            </div>
        </div>
    `;
    
    // Replace add button with input form
    addButton.parentElement.insertBefore(newBracketForm, addButton);
    // Transform ADD button to SAVE button (like age brackets)
    addButton.textContent = 'SAVE';
    
    // Change button onclick to save function
    addButton.onclick = function() { saveNewSpendBracket(); };
    
    // Focus on first input
    document.getElementById('new-spend-min').focus();

        
        // Bracket data sync removed - prevents triggering 'Weights Updated'
    }

    // BRACKET SYNCHRONIZATION FUNCTIONS - Added for simplified bracket approach like sliders
    function updateAgeBracketsData() {
        console.log('Updating age brackets data from display');
        const ageBrackets = [];
        const ageBracketElements = document.querySelectorAll('#age-brackets-list > div');
        
        ageBracketElements.forEach((element, index) => {
            try {
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                console.log('Skipping bracket element', index, '- invalid structure');
                return;
                }

                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                console.log('Skipping bracket element', index, '- invalid bracket content');
                return;
                }

                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    
                    // Parse range (e.g., "18-25" or "65+")
                    let minAge, maxAge;
                    if (rangeText.includes('+')) {
                        minAge = parseInt(rangeText.replace('+', ''));
                        maxAge = 999;
                    } else if (rangeText.includes('-')) {
                        const parts = rangeText.split('-');
                        minAge = parseInt(parts[0]);
                        maxAge = parseInt(parts[1]);
                    }
                    
                    // Parse percentage (e.g., "10%")
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    if (!isNaN(minAge) && !isNaN(maxAge) && !isNaN(percentage)) {
                        ageBrackets.push({
                            min_age: minAge,
                            max_age: maxAge,
                            percentage: percentage,
                            order: index + 1
                        });
                    }
                }
            } catch (error) {
                console.warn('Error parsing age bracket:', error);
            }
        });
        
        // Update hidden field
        const hiddenField = document.getElementById('age-brackets-data');
        if (hiddenField) {
            hiddenField.value = JSON.stringify(ageBrackets);
            console.log('Age brackets data updated:', ageBrackets.length, 'brackets');
        }
        
        return ageBrackets;
    }

    function updateSpendBracketsData() {
        console.log('Updating spend brackets data from display');
        const spendBrackets = [];
        const spendBracketElements = document.querySelectorAll('#spend-brackets-list > div');
        
        spendBracketElements.forEach((element, index) => {
            try {
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                console.log('Skipping bracket element', index, '- invalid structure');
                return;
                }

                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                console.log('Skipping bracket element', index, '- invalid bracket content');
                return;
                }

                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    
                    // Parse range (e.g., "$0-$1999" or "$5000+")
                    let minSpend, maxSpend;
                    const cleanRange = rangeText.replace(/[$,]/g, '');
                    
                    if (cleanRange.includes('+')) {
                        minSpend = parseFloat(cleanRange.replace('+', ''));
