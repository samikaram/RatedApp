                        // Keep maxSpend blank for unlimited detection
                    } else if (cleanRange.includes('-')) {
                        const parts = cleanRange.split('-');
                        minSpend = parseFloat(parts[0]);
                        maxSpend = parseFloat(parts[1]);
                    }
                    
                    // Parse percentage (e.g., "15%")
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    // Handle + brackets: set maxSpend to high value if NaN
                console.log("üîç DEBUG SPEND NaN:", {cleanRange, minSpend, maxSpend_before: maxSpend, isNaN_maxSpend: isNaN(maxSpend), includes_plus: cleanRange.includes('+')});
                if (isNaN(maxSpend) && cleanRange.includes('+')) {
                    maxSpend = 999999;
                console.log("üîç DEBUG SPEND NaN FIXED:", {maxSpend_after: maxSpend});
                }
                
                console.log("üîç DEBUG SPEND VALIDATION:", {minSpend, maxSpend, percentage, minSpend_valid: !isNaN(minSpend), maxSpend_valid: !isNaN(maxSpend), percentage_valid: !isNaN(percentage)});
                if (!isNaN(minSpend) && !isNaN(maxSpend) && !isNaN(percentage)) {

                console.log("üîç DEBUG SPEND PUSH:", {min_spend: minSpend, max_spend: maxSpend, percentage: percentage, order: index + 1});
                        spendBrackets.push({
                            min_spend: minSpend,
                            max_spend: maxSpend,
                            percentage: percentage,
                            order: index + 1
                        });
                    }
                }
            } catch (error) {
                console.warn('Error parsing spend bracket:', error);
            }
        });
        
        // Update hidden field
        const hiddenField = document.getElementById('spend-brackets-data');
        if (hiddenField) {
            hiddenField.value = JSON.stringify(spendBrackets);
            console.log('Spend brackets data updated:', spendBrackets.length, 'brackets');
        }
        
        return spendBrackets;
    }

    function syncAllBracketData() {
    console.log('üîç syncAllBracketData() called - this calls updateAgeBracketsData');
        console.log('Syncing all bracket data with hidden fields');
        updateAgeBracketsData();
        updateSpendBracketsData();
        console.log('All bracket data synchronized');
    }

function saveNewSpendBracket() {
    console.log("DEBUG: saveNewSpendBracket function called!");
    
    // Get form values
    const minSpend = document.getElementById("new-spend-min").value;
    const maxSpend = document.getElementById("new-spend-max").value || "";
    const percentage = document.getElementById("new-spend-percentage").value;
    
    // Validation
    if (!minSpend || !percentage) {
        alert("Please fill in minimum spend and percentage");
        return;
    }
    
    // Validate percentage range
    if (percentage < 0 || percentage > 100) {
        alert("Percentage must be between 0 and 100");
        return;
    }
    
    const finalMaxSpend = maxSpend || 999999;
    
    // Create bracket element for display (screen-only)
    const spendBracketsContainer = document.getElementById("spend-brackets-list");
    if (spendBracketsContainer) {
        // Create the new bracket element
        const newBracketDiv = document.createElement("div");
        newBracketDiv.style.cssText = "display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 8px;";
        
        const bracketContent = document.createElement("div");
        bracketContent.style.cssText = "display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;";
        
        const rangeDiv = document.createElement("div");
        rangeDiv.style.cssText = "padding: 4px 12px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;";
        rangeDiv.textContent = (finalMaxSpend >= 999999) ? minSpend + "+" : minSpend + "-" + finalMaxSpend;
        
        const percentDiv = document.createElement("div");
        percentDiv.style.cssText = "padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #333; min-width: 50px; text-align: center;";
        percentDiv.textContent = percentage + "%";
        
        const deleteButtonDiv = document.createElement("div");
        deleteButtonDiv.style.cssText = "display: flex; gap: 4px; margin-top: 2px;";
        
        const deleteButton = document.createElement("button");
        deleteButton.style.cssText = "background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;";
        deleteButton.textContent = "Delete";
        deleteButton.onclick = function() { 
            newBracketDiv.remove(); 
            console.log("Spend bracket removed from display");
        };
        
        // Assemble the bracket
        bracketContent.appendChild(rangeDiv);
        bracketContent.appendChild(percentDiv);
        deleteButtonDiv.appendChild(deleteButton);
        newBracketDiv.appendChild(bracketContent);
        newBracketDiv.appendChild(deleteButtonDiv);
        
        // Add to container
        spendBracketsContainer.appendChild(newBracketDiv);
        
        console.log("Spend bracket added to display:", rangeDiv.textContent, percentDiv.textContent);
    }
    
    // Clear form inputs
    document.getElementById("new-spend-min").value = "";
    document.getElementById("new-spend-max").value = "";
    document.getElementById("new-spend-percentage").value = "";
    
    // Remove the input form
    const inputForm = document.querySelector('div[style*="border: 1px solid #007bff"]');
    if (inputForm) {
        inputForm.remove();
    }
    
    // Reset ADD button
    const addButton = document.querySelector('button[onclick*="addNewSpendBracket"]');
    if (addButton) {
        addButton.textContent = "+ ADD";
        addButton.style.background = "#28a745";
        addButton.onclick = function() { addNewSpendBracket(); };
    }
    
    console.log("Spend bracket save complete - screen only, no backend call");
}
function cancelNewSpendBracket() {
    // Remove input form
    const inputForm = document.querySelector('div[style*="border: 1px solid #007bff"]');
    if (inputForm) {
        inputForm.remove();
    }
    // Reset ADD button
    if (currentAddButton) {
        currentAddButton.textContent = "+ ADD";
        currentAddButton.style.background = "#28a745";
        }
        currentAddButton.onclick = function() { addNewSpendBracket(); };
}
// Open spend brackets accordion if URL parameter exists
if (window.location.href.includes("spend_open=true")) {
    const content = document.getElementById("spend-brackets-content");
    const arrow = document.getElementById('spend-brackets-header')?.children[1]; // Safe: direct child access
    if (content && arrow) {
        content.style.display = "block";
        arrow.textContent = "‚ñ≤";
    }
}

function editConsecutivePoints() {
    document.getElementById("consecutive-points-display").style.display = "none";
    document.getElementById("edit-consecutive-btn").style.display = "none";
    document.getElementById("consecutive-input").style.display = "inline";
    document.getElementById("save-consecutive-btn").style.display = "inline-block";
    document.getElementById("consecutive-input").focus();
}

function saveConsecutivePoints() {
    const newValue = document.getElementById("consecutive-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("consecutive-points-display").textContent = newValue;
        document.getElementById("consecutive-hidden").value = newValue;
        
        // Reset UI state

        // Referrer Score Edit/Save Functions






        document.getElementById("consecutive-points-display").style.display = "inline";
        document.getElementById("edit-consecutive-btn").style.display = "inline-block";
        document.getElementById("consecutive-input").style.display = "none";
        document.getElementById("save-consecutive-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

function editCancellationsPoints() {
    document.getElementById("cancellations-points-display").style.display = "none";
    document.getElementById("edit-cancellations-btn").style.display = "none";
    document.getElementById("cancellations-input").style.display = "inline";
    document.getElementById("save-cancellations-btn").style.display = "inline-block";
    document.getElementById("cancellations-input").focus();
}

function saveCancellationsPoints() {
    const newValue = document.getElementById("cancellations-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("cancellations-points-display").textContent = newValue;
        document.getElementById("cancellations-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("cancellations-points-display").style.display = "inline";
        document.getElementById("edit-cancellations-btn").style.display = "inline-block";
        document.getElementById("cancellations-input").style.display = "none";
        document.getElementById("save-cancellations-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

function editDNAPoints() {
    document.getElementById("dna-points-display").style.display = "none";
    document.getElementById("edit-dna-btn").style.display = "none";
    document.getElementById("dna-input").style.display = "inline";
    document.getElementById("save-dna-btn").style.display = "inline-block";
    document.getElementById("dna-input").focus();
}

function saveDNAPoints() {
    const newValue = document.getElementById("dna-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("dna-points-display").textContent = newValue;
        document.getElementById("dna-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("dna-points-display").style.display = "inline";
        document.getElementById("edit-dna-btn").style.display = "inline-block";
        document.getElementById("dna-input").style.display = "none";
        document.getElementById("save-dna-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

function editUnpaidInvoicesPoints() {
    document.getElementById("unpaid-invoices-points-display").style.display = "none";
    document.getElementById("edit-unpaid-invoices-btn").style.display = "none";
    document.getElementById("unpaid-invoices-input").style.display = "inline";
    document.getElementById("save-unpaid-invoices-btn").style.display = "inline-block";
    document.getElementById("unpaid-invoices-input").focus();
}

function saveUnpaidInvoicesPoints() {
    const newValue = document.getElementById("unpaid-invoices-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("unpaid-invoices-points-display").textContent = newValue;
        document.getElementById("unpaid-invoices-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("unpaid-invoices-points-display").style.display = "inline";
        document.getElementById("edit-unpaid-invoices-btn").style.display = "inline-block";
        document.getElementById("unpaid-invoices-input").style.display = "none";
        document.getElementById("save-unpaid-invoices-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

        // Scoring Presets Accordion Toggle Function
                // Preset Management Functions
        function toggleCreateForm() {
            const form = document.getElementById('create-form');
            const btn = document.getElementById('create-preset-btn');
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'inline-block';
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
        }

        function cancelCreateForm() {
            const form = document.getElementById('create-form');
            const btn = document.getElementById('create-preset-btn');
            
            form.style.display = 'none';
            btn.disabled = false;
            btn.style.opacity = '1';
            document.getElementById('preset-name').value = '';
            document.getElementById('preset-description').value = '';
        }


        function saveNewPreset() {
    console.log('üîç saveNewPreset() called - this might trigger handleFormSubmit');
            const name = document.getElementById('preset-name').value;
            const description = document.getElementById('preset-description').value;
            
            if (!name.trim()) {
                alert('Please enter a preset name.');
                return;
            }
            
            // CONFIRMATION POPUP - New addition
            const confirmMessage = `Confirm creation of the '${name.trim()}' preset?`;
            if (!confirm(confirmMessage)) {
                // User clicked Cancel - stay in create mode
                console.log('Preset creation cancelled by user');
                return;
            }
            
            // User clicked OK - proceed with creation
            console.log('Creating preset with backend integration:', name, description);
            
            // Show loading state
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            // Prepare form data
            const formData = new FormData();
            formData.append('action', 'save_preset');
            formData.append('preset_name', name);
            formData.append('preset_description', description);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Capture current slider values from DOM
            console.log('Capturing current slider values...');
            const sliderFields = [
                'future_appointments_weight',
                'age_demographics_weight', 
                'yearly_spend_weight',
                'consecutive_attendance_weight',
                'referrer_score_weight',
                'cancellations_weight',
                'dna_weight',
                'unpaid_invoices_weight',
                'open_dna_invoice_weight'
            ];
            
            sliderFields.forEach(fieldName => {
                const slider = document.querySelector(`input[name="${fieldName}"]`);
                if (slider) {
                    formData.append(fieldName, slider.value);
                    console.log(`Added ${fieldName}: ${slider.value}`);
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.warn(`Slider not found: ${fieldName}`);
                }
            });
            
            // Capture current points values from hidden fields
            console.log('Capturing current points values...');
            const pointsFields = [
                {name: 'points_per_consecutive_attendance', hiddenId: 'consecutive-hidden'},
                {name: 'points_per_referral', hiddenId: 'referrer-hidden'},
                {name: 'points_per_cancellation', hiddenId: 'cancellations-hidden'},
                {name: 'points_per_dna', hiddenId: 'dna-hidden'},
                {name: 'points_per_unpaid_invoice', hiddenId: 'unpaid-invoices-hidden'}
            ];
            
                        console.log("üîç DEBUG: pointsFields array:", pointsFields);
            pointsFields.forEach(field => {
                const hiddenInput = document.getElementById(field.hiddenId);
                if (hiddenInput) {
                    formData.append(field.name, hiddenInput.value);
                    console.log(`Added ${field.name}: ${hiddenInput.value}`);
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.warn(`Hidden field not found: ${field.hiddenId}`);
                }
            });
            
  
        
        // SIMPLIFIED BRACKET CAPTURE - Using hidden fields like sliders
        console.log('Using simplified bracket capture from hidden fields');
        
        // Sync current display with hidden fields first
        syncAllBracketData();
        
        // Read bracket data from hidden fields (like sliders)
        const ageBracketsData = document.getElementById('age-brackets-data').value;
        const spendBracketsData = document.getElementById('spend-brackets-data').value;
        
        if (ageBracketsData) {
            formData.append('age_brackets_data', ageBracketsData);
            console.log('Added age brackets data from hidden field');
        }
        
        if (spendBracketsData) {
            formData.append('spend_brackets_data', spendBracketsData);
            console.log('Added spend brackets data from hidden field');
        }
        
        // FALLBACK: Complex bracket capture (existing logic)          // Capture current age brackets from screen display (based on DOM investigation)
            console.log('Capturing current age brackets from screen...');
            const ageBrackets = [];
            const ageBracketElements = document.querySelectorAll('#age-brackets-list > div');
            
            ageBracketElements.forEach((element, index) => {
                // Based on investigation: nested div structure with range and percentage
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                console.log('Skipping bracket element', index, '- invalid structure');
                return;
                }

                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                console.log('Skipping bracket element', index, '- invalid bracket content');
                return;
                }

                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    let minAge, maxAge;
                    // Handle "65+" format and "18-25" format (from investigation)
                    if (rangeText.includes('+')) {
                        minAge = parseInt(rangeText.replace('+', ''));
                        maxAge = 999;
                    } else if (rangeText.includes('-')) {
                        const parts = rangeText.split('-');
                        minAge = parseInt(parts[0]);
                        maxAge = parseInt(parts[1]);
                    }
                    
                    if (!isNaN(minAge) && !isNaN(maxAge) && !isNaN(percentage)) {
                        ageBrackets.push({
                            min_age: minAge,
                            max_age: maxAge,
                            percentage: percentage,
                            order: index
                        });
                        console.log(`Added age bracket: ${minAge}-${maxAge}, ${percentage}%`);
                    }
                }
            });
            
            if (ageBrackets.length > 0) {
                formData.append('screen_age_brackets', JSON.stringify(ageBrackets));
                console.log(`Captured ${ageBrackets.length} age brackets from screen`);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.log('No age brackets found on screen');
            }
            
            // Capture current spend brackets from screen display (based on DOM investigation)
            console.log('Capturing current spend brackets from screen...');
            const spendBrackets = [];
            const spendBracketElements = document.querySelectorAll('#spend-brackets-list > div');
            
            spendBracketElements.forEach((element, index) => {
                // Same structure as age brackets but with spend amounts
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                    console.log('Skipping spend bracket element', index, '- invalid structure');
                    return;
                }
                
                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                    console.log('Skipping spend bracket element', index, '- invalid bracket content');
                    return;
                }
                
                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    let minSpend, maxSpend;
                    // Handle spend format with $ symbols
                    if (rangeText.includes('+')) {
                        minSpend = parseFloat(rangeText.replace('+', '').replace('$', ''));
                        // Keep maxSpend blank for unlimited detection
                    } else if (rangeText.includes('-')) {
                        const parts = rangeText.split('-');
                        minSpend = parseFloat(parts[0].replace('$', ''));
                        maxSpend = parseFloat(parts[1].replace('$', ''));
                    }
                    
                    // Handle + brackets: set maxSpend to high value if NaN
                    if (isNaN(maxSpend) && rangeText.includes('+')) {
                        maxSpend = 999999;
                    }
                    
                    if (!isNaN(minSpend) && !isNaN(maxSpend) && !isNaN(percentage)) {
                        spendBrackets.push({
                            min_spend: minSpend,
                            max_spend: maxSpend,
                            percentage: percentage,
                            order: index
                        });
                        console.log(`Added spend bracket: $${minSpend}-$${maxSpend}, ${percentage}%`);
                    }
                }
            });
            
            if (spendBrackets.length > 0) {
                formData.append('screen_spend_brackets', JSON.stringify(spendBrackets));
                console.log(`Captured ${spendBrackets.length} spend brackets from screen`);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.log('No spend brackets found on screen');
            }
            
            // Call backend (basic structure)
            fetch('/patients/dashboard/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Backend response:', data);
                
                if (data.success) {
                
                // Update accordion header - saveNewPreset (NON-BOLD - created but not applied)
                const accordionTitle = document.querySelector('.accordion-title');
                if (accordionTitle && data.preset && data.preset.name) {
                    accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: ${data.preset.name}`;
                    console.log('Accordion header updated to show new preset:', data.preset.name);
                // Show success message
                const saveMessage = document.getElementById("save-message");
                if (saveMessage) {
                    saveMessage.textContent = "‚úÖ Success";
                    saveMessage.style.display = "block";
                    setTimeout(() => {
                        saveMessage.style.display = "none";
                    }, 3000);
                }
                
                }
                    // Temporary: Keep existing UI updates for now
                    const header = document.querySelector('.accordion-title');
                    header.innerHTML = "‚öôÔ∏è <strong>Scoring Presets</strong> - Current preset: " + name;
                    
                    const dropdown = document.getElementById('preset-dropdown');
                    const option = document.createElement('option');
                    option.value = data.preset_id || name.toLowerCase().replace(/\s+/g, '_');
                    option.text = name;
                    dropdown.add(option);
                    dropdown.value = option.value;
                    
                    // Show success message next to Update Weights button
                    const saveMessage = document.getElementById('save-message');
                    if (saveMessage) {
                        saveMessage.style.display = 'inline';
                        setTimeout(() => {
                            saveMessage.style.display = 'none';
                        }, 3000); // Hide after 3 seconds
                    }
                    cancelCreateForm();
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.error('Error creating preset:', data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('AJAX error:', error);
                console.error('Error creating preset:', error.message);
            })
            .finally(() => {
                // Restore button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
        }


    
    // Scoring Presets Toggle Function
    function updateCurrentPreset() {
    // Get the current preset name from the header
    const presetNameElement = document.querySelector('.accordion-title strong:last-of-type');
    const updatePresetName = presetNameElement ? presetNameElement.textContent.trim() : 'Unknown';
    
    // Show confirmation popup
    if (confirm(`Do you wish to update the ${updatePresetName} preset?`)) {
        // Collect all current screen state data
        const formData = collectCurrentScreenState();
        
        // Add the update_preset action
        formData.append('action', 'update_preset');
        formData.append('preset_name', updatePresetName);
        
        // Show loading state
        const updateBtn = document.getElementById('update-preset-btn');
        const originalText = updateBtn.textContent;
        updateBtn.textContent = 'Updating...';
        updateBtn.disabled = true;
        
        // Send AJAX request to backend
        fetch('/patients/dashboard/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            // Restore button state
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
            
            if (data.success) {
                // SUCCESS: Get current preset ID and reapply the updated preset
                console.log('‚úÖ Preset updated successfully:', updatePresetName);
                
                // Get the current applied preset ID from dropdown
                // Get the current applied preset ID from dropdown or find by name
                const dropdown = document.getElementById('preset-dropdown');
                let currentPresetId = dropdown ? dropdown.value : null;
                
                // If dropdown is empty, try to find preset by name
                if (!currentPresetId && updatePresetName) {
                    const options = dropdown ? dropdown.options : [];
                    for (let option of options) {
                        if (option.text === updatePresetName) {
                            currentPresetId = option.value;
                            break;
                        }
                    }
                }
                
                if (currentPresetId && updatePresetName) {
                    // Reapply the updated preset to refresh all UI
                    console.log('üîÑ Reapplying updated preset:', currentPresetId, updatePresetName);
                    applyPresetById(currentPresetId, updatePresetName);
                } else {
                    console.error('‚ùå Could not get preset ID for reapplication:', {currentPresetId, updatePresetName});
                    // Fallback: manual header update
                    const accordionTitle = document.querySelector('.accordion-title');
                    if (accordionTitle) {
                        accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>${updatePresetName}</strong>`;
                    }
                }
                
                // Show success message
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = "‚úÖ Success";
                    saveMessage.style.display = 'block';
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                    }, 3000);
                }
            } else {
                // Show error in existing message element
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = '‚ùå Error updating preset: ' + (data.error || 'Unknown error');
                    saveMessage.style.color = '#dc3545';
                    saveMessage.style.display = 'block';
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                        saveMessage.style.color = '#28a745'; // Reset to green
                    }, 5000);
                }
            }
        })
        .catch(error => {
            // Restore button state
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
            
            console.error('Error updating preset:', error);
            // Show error in existing message element
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = '‚ùå Error updating preset: ' + error.message;
                    saveMessage.style.color = '#dc3545';
                    saveMessage.style.display = 'block';
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                        saveMessage.style.color = '#28a745'; // Reset to green
                    }, 5000);
                }
        });
    }
}

function collectCurrentScreenState() {
    console.log('üîç collectCurrentScreenState() called - this calls syncAllBracketData');
    // Sync all bracket data before collection
    syncAllBracketData();
    
    const formData = new FormData();
    
    // Collect all slider values
    const sliders = ['future_appointments_weight', 'age_demographics_weight', 'yearly_spend_weight', 
                    'consecutive_attendance_weight', 'referrer_score_weight', 'cancellations_weight', 'dna_weight', 
                    'unpaid_invoices_weight', 'open_dna_invoice_weight'];
    
    sliders.forEach(sliderId => {
        const slider = document.querySelector(`input[name="${sliderId}"]`);
        if (slider) {
            formData.append(sliderId, slider.value);
        }
    });
    
    // Collect all points values
    const pointsFields = ['points_per_consecutive_attendance', 'points_per_referral', 'points_per_cancellation', 
                         'points_per_dna', 'points_per_unpaid_invoice'];
    
    pointsFields.forEach(fieldId => {
        const inputField = document.querySelector(`input[name='${fieldId}']`);
        if (inputField) {
            formData.append(fieldId, inputField.value);
        }
    });
    
    // Collect age brackets from current display
    const ageBrackets = [];
    const ageBracketElements = document.querySelectorAll('#age-brackets-list > div');
    ageBracketElements.forEach((element, index) => {
        const rangeText = element.children[0]?.children[0]?.textContent?.trim();
        const percentageText = element.children[0]?.children[1]?.textContent?.trim();
        
        if (rangeText && percentageText) {
            const percentage = parseInt(percentageText.replace('%', ''));
            let minAge, maxAge;
            
            if (rangeText.includes('+')) {
                minAge = parseInt(rangeText.replace('+', ''));
                maxAge = 999;
            } else if (rangeText.includes('-')) {
                const parts = rangeText.split('-');
                minAge = parseInt(parts[0]);
                // Clean parsing - no corruption fix needed with proper DOM navigation
                maxAge = parseInt(parts[1]);
            }
            
            if (!isNaN(minAge) && !isNaN(maxAge) && !isNaN(percentage)) {
                ageBrackets.push({
                    min_age: minAge,
                    max_age: maxAge,
                    percentage: percentage,
                    order: index
                });
            }
        }
    });
    
    if (ageBrackets.length > 0) {
        formData.append('age_brackets_data', JSON.stringify(ageBrackets));
    }
    
    // Collect spend brackets from current display
    const spendBrackets = [];
    const spendBracketElements = document.querySelectorAll('#spend-brackets-list > div');
    spendBracketElements.forEach((element, index) => {
        const rangeText = element.children[0]?.children[0]?.textContent?.trim();
        const percentageText = element.children[0]?.children[1]?.textContent?.trim();
        
        if (rangeText && percentageText) {
            const percentage = parseInt(percentageText.replace('%', ''));
            let minSpend, maxSpend;
            
            if (rangeText.includes('+')) {
                minSpend = parseFloat(rangeText.replace('+', ''));
                maxSpend = 999999;  // Set high value for + brackets (copied from working age logic)
            } else if (rangeText.includes('-')) {
                const parts = rangeText.split('-');
                minSpend = parseFloat(parts[0]);
                maxSpend = parseFloat(parts[1]);
            }
            if (!isNaN(minSpend) && !isNaN(maxSpend) && !isNaN(percentage)) {
                spendBrackets.push({
                    min_spend: minSpend,
                    max_spend: maxSpend,
                    percentage: percentage,
                    order: index
                });
            }
        }
    });
    
    if (spendBrackets.length > 0) {
        formData.append('spend_brackets_data', JSON.stringify(spendBrackets));
    }
    
    return formData;
}

function toggleScoringPresets() {
        console.log('Scoring Presets clicked');
        const content = document.getElementById('scoring-presets-content');
        const arrow = document.getElementById('presets-arrow');
        
        if (content) {
            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                content.style.maxHeight = '500px';
                if (arrow) arrow.textContent = '‚ñ≤';
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                content.style.maxHeight = '0px';
                if (arrow) arrow.textContent = '‚ñº';
            }
                
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
            console.error('scoring-presets-content not found');
        }
    }
    
    // Placeholder functions for preset management
    
    function toggleCreateForm() {
