        console.log('Toggle create form clicked');
        const form = document.getElementById('create-form');
        if (form) {
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    // Removed duplicate saveNewPreset stub - using main implementation
    
    function cancelCreateForm() {
        console.log('Cancel create form clicked');
        const form = document.getElementById('create-form');
        if (form) {
            form.style.display = 'none';
        }
    }
        
        // STEP 3: Minimal Preset Loading Function - Safe Implementation
        function loadPresets() {
            console.log('üîÑ Loading presets into dropdown...');
            
            fetch('/patients/presets/get/')
                .then(response => {
                    console.log('üì° Response received:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Preset data:', data);
                    
                    const presetSelect = document.getElementById('preset-dropdown');
                    if (presetSelect && data.presets) {
                        console.log('‚úÖ Found dropdown element and preset data');
                        
                        // Clear existing options except first
                        const firstOption = presetSelect.firstElementChild;
                        presetSelect.innerHTML = '';
                        if (firstOption) {
                            presetSelect.appendChild(firstOption);
                        }
                        
                        // Add preset options
                        data.presets.forEach(preset => {
                            const option = document.createElement('option');
                            option.value = preset.id;
                            option.textContent = preset.name;
                            presetSelect.appendChild(option);
                            console.log('‚ûï Added preset:', preset.name);
                        });
                        
                        console.log('üéâ Successfully loaded ' + data.presets.length + ' presets');
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.warn('‚ö†Ô∏è Dropdown element or preset data not found');
                        console.log('Available elements:', document.querySelectorAll('[id*="preset"]'));
                    }
                })
                .catch(error => {
                    console.error('üö® Error loading presets:', error);
                });
        }
        
        // Auto-load presets when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded, auto-loading presets...');
            loadPresets();
    
    // Restore applied preset header after page refresh
    // DISABLED AUTOLOAD: const savedPresetName = localStorage.getItem('appliedPresetName');
    // DISABLED AUTOLOAD: if (savedPresetName) {
    // DISABLED AUTOLOAD: console.log('üîÑ Restoring applied preset header:', savedPresetName);
    // DISABLED AUTOLOAD: updatePresetHeader(savedPresetName);
    // DISABLED AUTOLOAD: }
        });

        // ===== DISPLAY BUTTON FUNCTIONALITY - SAFE ADDITION =====
        // Added: July 23, 2025 - No existing code modified
        
        function displayPreset() {
            console.log('Display button clicked - Safe implementation');
            
            const dropdown = document.getElementById('preset-dropdown');
            if (dropdown === null) {
                console.error('Preset dropdown not found');
                alert('Error: Preset dropdown not found');
                return;
            }
            
            const selectedValue = dropdown.value;
    
    // Set global variables for handleFormSubmit to use
    window.applyPresetInProgress = true;
    window.selectedPresetValue = selectedValue;
            if (selectedValue === '' || selectedValue === null) {
                console.log('No preset selected');
                alert('Please select a preset first');
                return;
            }
            
            console.log('Fetching preset data for ID:', selectedValue);
            
            fetch('/patients/presets/get/' + selectedValue + '/')
                .then(function(response) {
                    console.log('Response status:', response.status);
                    if (response.ok === false) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('Preset data received:', data);
                    if (data.success === true && data.preset) {
            
            // Update accordion header - displayPreset (NON-BOLD - Display-only)
            const accordionTitle = document.querySelector('.accordion-title');
            const dropdown = document.getElementById('preset-dropdown');
            if (accordionTitle && dropdown) {
                const presetName = dropdown.options[dropdown.selectedIndex].text;
                accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: ${presetName}`;
            }
            
                        loadPresetIntoSliders(data.preset);

            // CRITICAL FIX: Update bracket displays on screen
            console.log('Updating bracket displays from preset data...');
            
            // Update age brackets display
            if (data.preset && data.preset.age_brackets) {
                updateAgeBracketsDisplay(data.preset.age_brackets);
                console.log('Updated age brackets display with', data.preset.age_brackets.length, 'brackets');
            }
            
            // Update spend brackets display
            if (data.preset && data.preset.spend_brackets) {
                updateSpendBracketsDisplay(data.preset.spend_brackets);
                console.log('Updated spend brackets display with', data.preset.spend_brackets.length, 'brackets');
            }
            
            console.log('All preset elements updated on screen - sliders, points, and brackets');

            // Show success message
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.textContent = "‚úÖ Success";
                saveMessage.style.display = "block";
                setTimeout(() => {
                    saveMessage.style.display = "none";
                }, 3000);
            }
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.error('Invalid preset data:', data);
                        alert('Error: Invalid preset data received');
                    }
                })
                .catch(function(error) {
                    console.error('Error fetching preset:', error);
                    alert('Error fetching preset data: ' + error.message);
                });
        }
        

    // CRITICAL FIX: Missing bracket update functions for Apply/Display buttons
    function updateAgeBracketsDisplay(brackets) {
        console.log('updateAgeBracketsDisplay called with', brackets.length, 'brackets');
        
        // Find the age brackets display container
        const ageBracketsContainer = document.getElementById('age-brackets-list');
        if (!ageBracketsContainer) {
            console.error('Age brackets container not found');
            return;
        }
        
        // CRITICAL FIX: Preserve ADD button, only remove bracket divs
        const addButton = ageBracketsContainer.querySelector('button[onclick="addNewAgeBracket(event)"]');
        const bracketDivs = ageBracketsContainer.querySelectorAll('div[style*="flex-direction: column"]');
        bracketDivs.forEach(div => div.remove());
        
        // Add each bracket with CORRECT original HTML structure
        brackets.forEach((bracket, index) => {
            const outerDiv = document.createElement('div');
            outerDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
            
            const bracketContent = document.createElement('div');
            bracketContent.style.cssText = 'display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;';
            
            const rangeDiv = document.createElement('div');
            rangeDiv.style.cssText = 'padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;';
            console.log("üîç DEBUG AGE DISPLAY: bracket.max_age =", bracket.max_age, "type:", typeof bracket.max_age);
            console.log("üîç DEBUG AGE DISPLAY: Condition checks:", {
                "!bracket.max_age": !bracket.max_age,
                "bracket.max_age === ''": bracket.max_age === '',
                "bracket.max_age === undefined": bracket.max_age === undefined,
                "bracket.max_age === null": bracket.max_age === null,
                "bracket.max_age >= 999": bracket.max_age >= 999
            });
            rangeDiv.textContent = (!bracket.max_age || bracket.max_age === '' || bracket.max_age === undefined || bracket.max_age === null || bracket.max_age >= 999) ? bracket.min_age + '+' : bracket.min_age + '-' + bracket.max_age;
            console.log("üîç DEBUG AGE DISPLAY: Final display =", rangeDiv.textContent);
            
            const percentDiv = document.createElement('div');
            percentDiv.style.cssText = 'padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;';
            percentDiv.textContent = bracket.percentage + '%';
            
            bracketContent.appendChild(rangeDiv);
            bracketContent.appendChild(percentDiv);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 4px; margin-top: 2px;';
            
            const deleteButton = document.createElement('button');
            deleteButton.setAttribute('onclick', `deleteAgeBracket(${bracket.id || index})`);
            deleteButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;';
            deleteButton.textContent = 'Delete';
            
            buttonContainer.appendChild(deleteButton);
            outerDiv.appendChild(bracketContent);
            outerDiv.appendChild(buttonContainer);
            
            // Insert before ADD button to maintain order
            if (addButton) {
                ageBracketsContainer.insertBefore(outerDiv, addButton);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                ageBracketsContainer.appendChild(outerDiv);
            }
        });
        
        console.log('Age brackets display updated with preserved structure');
    }

    function updateSpendBracketsDisplay(brackets) {
        console.log('updateSpendBracketsDisplay called with', brackets.length, 'brackets');
        
        // Find the spend brackets display container
        const spendBracketsContainer = document.getElementById('spend-brackets-list');
        if (!spendBracketsContainer) {
            console.error('Spend brackets container not found');
            return;
        }
        
        // CRITICAL FIX: Preserve ADD button, only remove bracket divs
        const addButton = spendBracketsContainer.querySelector('button[onclick="addNewSpendBracket(event)"]');
        const bracketDivs = spendBracketsContainer.querySelectorAll('div[style*="flex-direction: column"]');
        bracketDivs.forEach(div => div.remove());
        
        // Add each bracket with CORRECT original HTML structure and NO $ signs
        brackets.forEach((bracket, index) => {
            const outerDiv = document.createElement('div');
            outerDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
            
            const bracketContent = document.createElement('div');
            bracketContent.style.cssText = 'display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;';
            
            const rangeDiv = document.createElement('div');
            rangeDiv.style.cssText = 'padding: 4px 12px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;';
            // CRITICAL FIX: NO $ signs - clean numbers only
            console.log("üîç DEBUG SPEND DISPLAY: bracket.max_spend =", bracket.max_spend, "type:", typeof bracket.max_spend);
            console.log("üîç DEBUG SPEND DISPLAY: Condition checks:", {
                "!bracket.max_spend": !bracket.max_spend,
                "bracket.max_spend === ''": bracket.max_spend === '',
                "bracket.max_spend === undefined": bracket.max_spend === undefined,
                "bracket.max_spend === null": bracket.max_spend === null,
                "bracket.max_spend >= 999999": bracket.max_spend >= 999999
            });
            rangeDiv.textContent = (!bracket.max_spend || bracket.max_spend === '' || bracket.max_spend === undefined || bracket.max_spend === null || bracket.max_spend >= 999999) ? bracket.min_spend + '+' : bracket.min_spend + '-' + bracket.max_spend;
            console.log("üîç DEBUG SPEND DISPLAY: Final display =", rangeDiv.textContent);
            
            const percentDiv = document.createElement('div');
            percentDiv.style.cssText = 'padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;';
            percentDiv.textContent = bracket.percentage + '%';
            
            bracketContent.appendChild(rangeDiv);
            bracketContent.appendChild(percentDiv);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 4px; margin-top: 2px;';
            
            const deleteButton = document.createElement('button');
            deleteButton.setAttribute('onclick', `deleteSpendBracket(${bracket.id || index})`);
            deleteButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;';
            deleteButton.textContent = 'Delete';
            
            buttonContainer.appendChild(deleteButton);
            outerDiv.appendChild(bracketContent);
            outerDiv.appendChild(buttonContainer);
            
            // Insert before ADD button to maintain order
            if (addButton) {
                spendBracketsContainer.insertBefore(outerDiv, addButton);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                spendBracketsContainer.appendChild(outerDiv);
            }
        });
        
        console.log('Spend brackets display updated with preserved structure and no $ signs');
    }

    function loadPresetIntoSliders(presetData) {
        console.log('Loading preset data into sliders:', presetData);
        
        // Load slider values (existing functionality)
        const sliderMappings = [
            { sliderName: 'future_appointments_weight', valueName: 'future_appointments_weight' },
            { sliderName: 'age_demographics_weight', valueName: 'age_demographics_weight' },
            { sliderName: 'yearly_spend_weight', valueName: 'yearly_spend_weight' },
            { sliderName: 'consecutive_attendance_weight', valueName: 'consecutive_attendance_weight' },
            { sliderName: 'referrer_score_weight', valueName: 'referrer_score_weight' },
            { sliderName: 'cancellations_weight', valueName: 'cancellations_weight' },
            { sliderName: 'dna_weight', valueName: 'dna_weight' },
            { sliderName: 'unpaid_invoices_weight', valueName: 'unpaid_invoices_weight' },
            { sliderName: 'open_dna_invoice_weight', valueName: 'open_dna_invoice_weight' }
        ];
        
        // Update sliders (existing logic)
        sliderMappings.forEach(mapping => {
            const slider = document.querySelector(`input[name="${mapping.sliderName}"]`);
            // CRITICAL FIX: Correct element selection with debugging
            let valueDisplayId;
            if (mapping.valueName === 'future_appointments_weight' || mapping.valueName === 'age_demographics_weight' || mapping.valueName === 'yearly_spend_weight' || mapping.valueName === 'consecutive_attendance_weight' || mapping.valueName === 'referrer_score_weight') {
                // These use clean pattern: future_appointments_value, age_demographics_value, etc.
                valueDisplayId = `${mapping.valueName.replace('_weight', '')}_value`;
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                // These use weight pattern: cancellations_weight_value, dna_weight_value, etc.
                valueDisplayId = `${mapping.valueName}_value`;
            }
            const valueDisplay = document.getElementById(valueDisplayId);
            
            // Debug logging
            console.log(`Slider: ${mapping.sliderName}, Looking for display: ${valueDisplayId}, Found: ${valueDisplay !== null}`);
            if (slider) console.log(`Slider found, setting value to: ${presetData[mapping.valueName]}`);
            if (valueDisplay) console.log(`Display found, setting text to: ${presetData[mapping.valueName]}`);
            if (!slider) console.error(`Slider not found: input[name="${mapping.sliderName}"]`);
            if (!valueDisplay) console.error(`Display not found: ${valueDisplayId}`);
            
            if (slider && presetData[mapping.valueName] !== undefined) {
                slider.value = presetData[mapping.valueName];
                if (valueDisplay) {
                    valueDisplay.textContent = presetData[mapping.valueName];
                }
            }
        });
        
        // CRITICAL FIX: Load points values from preset data (prevent contamination)
        console.log('Loading points values from preset data to prevent contamination...');
        
        const pointsMappings = [
            { 
                field: 'points_per_consecutive_attendance',
                displayId: 'consecutive-points-display',
                hiddenId: 'consecutive-hidden',
                inputId: 'consecutive-input'
            },
            {
                field: 'points_per_referral',
                displayId: 'referrer-points-display',
                hiddenId: 'referrer-hidden',
                inputId: 'referrer-input'
            },
            { 
                field: 'points_per_cancellation',
                displayId: 'cancellations-points-display',
                hiddenId: 'cancellations-hidden',
                inputId: 'cancellations-input'
            },
            { 
                field: 'points_per_dna',
                displayId: 'dna-points-display',
                hiddenId: 'dna-hidden',
                inputId: 'dna-input'
            },
            { 
                field: 'points_per_unpaid_invoice',
                displayId: 'unpaid-invoices-points-display',
                hiddenId: 'unpaid-invoices-hidden',
                inputId: 'unpaid-invoices-input'
            }
        ];
        
        // Update points displays and hidden fields from preset data
        pointsMappings.forEach(mapping => {
            if (presetData[mapping.field] !== undefined) {
                const displayElement = document.getElementById(mapping.displayId);
                const hiddenElement = document.getElementById(mapping.hiddenId);
                const inputElement = document.getElementById(mapping.inputId);
                
                const pointsValue = presetData[mapping.field];
                
                // Update display box
                if (displayElement) {
                    displayElement.textContent = pointsValue;
                }
                
                // Update hidden field (for form submission)
                if (hiddenElement) {
                    hiddenElement.value = pointsValue;
                }
                
                // Update input field (for editing)
                if (inputElement) {
                    inputElement.value = pointsValue;
                }
                
                console.log(`Updated ${mapping.field}: ${pointsValue}`);
            }
        });
        
        console.log('Points contamination fix applied - all points boxes now preset-specific');
    }
        
        // ===== END DISPLAY BUTTON FUNCTIONALITY =====
    
// Apply Button - Hybrid Implementation (Form Submission + AJAX Bracket Operations)
    function applyPreset() {
        console.log("üéØ applyPreset() called - using fixed implementation");
        
        const selectedPresetId = getSelectedPresetId();
        if (!selectedPresetId) {
            alert('Please select a preset to apply.');
            return;
        }
        
        console.log("üîç Applying preset ID:", selectedPresetId);
        
        // Use the working applyPresetById logic
        fetch('/patients/dashboard/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `action=apply_preset&preset_id=${selectedPresetId}`
        })
        .then(response => response.json())
        .then(data => {
            console.log("üîç DEBUG: Complete AJAX response data:", data);
            
            if (data.success) {
                console.log("‚úÖ Preset applied successfully via AJAX:", data.message);
                
                // Update header
                updatePresetHeader(data.preset?.name || 'Applied Preset');
                
                // Update dropdown to show applied preset
                const dropdown = document.getElementById('preset-dropdown');
                if (dropdown) {
                    dropdown.value = selectedPresetId;
                }
                
                // Apply all preset values to UI
                if (data.preset) {
                    console.log("üîç DEBUG: data.preset exists?", !!data.preset);
                    
                    // Update all sliders with preset values
                    const sliderFields = [
                        'future_appointments_weight', 'age_demographics_weight', 'yearly_spend_weight',
                        'consecutive_attendance_weight', 'referrer_score_weight', 'cancellations_weight', 'dna_weight',
                        'unpaid_invoices_weight', 'open_dna_invoice_weight'
                    ];
                    
                    sliderFields.forEach(field => {
                        const slider = document.getElementById(field);
                        const display = document.getElementById(field + '_display');
                        
                        if (slider && data.preset[field] !== undefined) {
                            slider.value = data.preset[field];
                            if (display) {
                                display.textContent = data.preset[field];
                            }
                            console.log(`‚úÖ Updated slider ${field}:`, data.preset[field]);
                        }
                    });
                    
                    console.log("üîç DEBUG: About to process points fields. data.preset exists:", !!data.preset);
                    // Update points fields
                    const pointsFields = [
                        'points_per_consecutive_attendance', 'points_per_referral', 'points_per_cancellation',
                        'points_per_dna', 'points_per_unpaid_invoice'
                    ];
                    
                    pointsFields.forEach(field => {
                        const display = document.getElementById(field.replace('points_per_', '') + '-points-display');
                        const hidden = document.getElementById(field.replace('points_per_', '') + '-hidden');
                        
                        if (display && data.preset[field] !== undefined) {
                            display.textContent = data.preset[field];
                            if (hidden) {
                                hidden.value = data.preset[field];
                            }
                            console.log(`‚úÖ Updated points ${field}:`, data.preset[field]);
                        }
                    });
                    
                    // Update brackets if included in response
                    
                    // DEBUG: Check bracket data location in response
                    console.log("üîç DEBUG: Checking bracket data in response...");
                    console.log("üîç DEBUG: data.age_brackets exists?", !!data.age_brackets);
                    console.log("üîç DEBUG: data.spend_brackets exists?", !!data.spend_brackets);
                    console.log("üîç DEBUG: data.preset.age_brackets exists?", !!data.preset.age_brackets);
                    console.log("üîç DEBUG: data.preset.spend_brackets exists?", !!data.preset.spend_brackets);
                    if (data.age_brackets) console.log("üîç DEBUG: data.age_brackets length:", data.age_brackets.length);
                    if (data.spend_brackets) console.log("üîç DEBUG: data.spend_brackets length:", data.spend_brackets.length);
                    if (data.preset.age_brackets) console.log("üîç DEBUG: data.preset.age_brackets length:", data.preset.age_brackets.length);
                    if (data.preset.spend_brackets) console.log("üîç DEBUG: data.preset.spend_brackets length:", data.preset.spend_brackets.length);
                    if (data.preset.age_brackets) {
                        updateAgeBracketsDisplay(data.preset.age_brackets);
                        console.log("‚úÖ Updated age brackets");
                    }
                    
                    if (data.preset.spend_brackets) {
                        updateSpendBracketsDisplay(data.preset.spend_brackets);
                        console.log("‚úÖ Updated spend brackets");
                    }
                    
                    console.log("‚úÖ All preset values applied to UI");
                } else {
                    console.log("‚ùå No preset data in response");
                }
                
                // Show success message
                showInlineSuccessMessage('preset-actions', 'Preset applied successfully');
                
            } else {
                console.error("‚ùå Apply preset failed:", data.message);
                alert('Failed to apply preset: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('‚ùå Apply preset error:', error);
            alert('Error applying preset. Please try again.');
        });
    }
    function submitFormWithPresetData(selectedValue, cleanPresetName, originalText) {
        console.log('Submitting form with loaded preset data...');
        
        // Step 2: Submit the main form to save all 8 slider values
    const form = document.querySelector("form");
    if (!form) {
        console.error("Scoring form not found");
        alert("Error: Could not find scoring form");
        return;
    }
    
    // Show loading state
    const applyButton = document.getElementById("apply-preset-btn");
    originalText = applyButton.innerHTML;
    applyButton.innerHTML = "Applying...";
    applyButton.disabled = true;
    
    // Submit form using existing handleFormSubmit logic
    
    // Sync current screen data to hidden fields before submission
    console.log("üîÑ Syncing bracket data before form submission");
    updateAgeBracketsData();
    updateSpendBracketsData();
    console.log("‚úÖ Bracket data synced successfully");

    const formData = new FormData(form);
    
    // DEBUG: Show what Apply button sends to Django
    console.log("üîç APPLY BUTTON DEBUG - FormData contents:");
    console.log(Array.from(formData.entries()));
    console.log("üîç Does Apply button send action parameter?", formData.get('action'));
    
    fetch("/patients/dashboard/", {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Form submission failed");
        }
        return response.json();
    })
    .then(data => {
        console.log("Form submitted successfully");
        
        // Step 2: Clear and bulk insert age brackets
        return clearAndInsertBrackets("age", selectedValue);
    })
    .then(() => {
        console.log("Age brackets updated successfully");
        
        // Step 3: Clear and bulk insert spend brackets  
        return clearAndInsertBrackets("spend", selectedValue);
    })
    .then(() => {
        console.log("Spend brackets updated successfully");
        
        // Step 4: Update UI to reflect changes
        updatePresetHeader(cleanPresetName);
            

            console.log("Saved applied preset to localStorage:", cleanPresetName);
        

        console.log('Saved applied preset to localStorage:', cleanPresetName);
        
        // Show success message
        alert("Preset applied successfully: " + cleanPresetName);
        
        // Restore button state
        applyButton.innerHTML = originalText;
        applyButton.disabled = false;
        
        console.log("Apply preset completed successfully");
        
        // Reset saving flag to unblock bracket buttons
        window.savingInProgress = false;
    })
    .catch(error => {
        console.error("Apply preset error:", error);
        alert("Error applying preset: " + error.message);
        
        // Restore button state on error
        applyButton.innerHTML = originalText;
        applyButton.disabled = false;
    });
}

// Helper function to clear and insert brackets
function clearAndInsertBrackets(bracketType, presetValue) {
    return new Promise((resolve, reject) => {
        // Step 1: Clear existing brackets
        fetch("/patients/dashboard/", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "Content-Type": "application/x-www-form-urlencoded",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: "action=clear_" + bracketType + "_brackets"
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || "Clear operation failed");
            }
            console.log("Cleared " + bracketType + " brackets:", data.deleted_count);
            
            // Step 2: Get bracket data for selected preset
            const bracketData = getBracketDataForPreset(bracketType, presetValue);
            
            // Step 3: Bulk insert new brackets
            return fetch("/patients/dashboard/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: "action=insert_" + bracketType + "_brackets&brackets_data=" + encodeURIComponent(JSON.stringify(bracketData))
            });
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || "Bulk insert failed");
            }
            console.log("Inserted " + bracketType + " brackets:", data.inserted_count);
            resolve(data);
        })
        .catch(error => {
            console.error("Error updating " + bracketType + " brackets:", error);
            reject(error);
        });
    });
}

// Helper function to get bracket data for preset (placeholder implementation)
function getBracketDataForPreset(bracketType, presetValue) {
    // This function should load bracket data from the database for the selected preset
    // For now, we'll use a synchronous approach with preset-specific data
    
    console.log('Loading bracket data for preset:', presetValue, 'type:', bracketType);
    
    // TODO: Replace with actual AJAX call to load brackets from database
    // For now, return different data based on preset ID
    
    if (presetValue == 1) { // Factory Settings
        if (bracketType === "age") {
            return [
                { min_age: 18, max_age: 25, percentage: 5, order: 1 },
                { min_age: 26, max_age: 35, percentage: 10, order: 2 },
                { min_age: 36, max_age: 45, percentage: 15, order: 3 },
                { min_age: 46, max_age: 55, percentage: 20, order: 4 },
                { min_age: 56, max_age: 65, percentage: 15, order: 5 },
                { min_age: 66, max_age: 100, percentage: 25, order: 6 }
            ];
        } else if (bracketType === "spend") {
            return []; // Factory Settings has no spend brackets
        }
    } else {
        // For other presets, return empty brackets for now
        // TODO: Load actual bracket data from database
        console.log('No bracket data defined for preset', presetValue);
        return [];
    }
    
    return [];
}

// Helper function to update preset header
function updatePresetHeader(presetName) {
    const header = document.querySelector(".accordion-title");
    if (header) {
        header.innerHTML = "‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>" + presetName + "</strong>";
        
        // Update the center buttons section
        const centerButtons = header.parentElement.querySelector('.center-buttons');
        if (centerButtons) {
            centerButtons.innerHTML = '<button id=\"update-preset-btn\" onclick=\"updateCurrentPreset()\" style=\"background: #007bff; color: white; border: none; padding: 5px 12px; border-radius: 3px; font-size: 0.85rem; cursor: pointer;\">Update</button><span class=\"info-icon\" title=\"This button updates the existing, applied preset.\">‚ìò</span>';
        }
    }
}

// Helper function to apply preset by ID (used by delete preset fallback)
function applyPresetById(presetId, presetName) {
    console.log('applyPresetById called with:', presetId, presetName);
    
    // Update header to show the preset being applied
    const accordionTitle = document.querySelector('.accordion-title');
    if (accordionTitle) {
        accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>${presetName}</strong>`;
        console.log('Header updated to show applied preset:', presetName);
    }
    
    // Set the dropdown to the specified preset
    const dropdown = document.getElementById('preset-dropdown');
    if (dropdown) {
        for (let i = 0; i < dropdown.options.length; i++) {
            if (dropdown.options[i].value === presetId.toString()) {
                dropdown.selectedIndex = i;
                console.log('Dropdown set to preset:', presetName);
                break;
            }
        }
    }
    
    // Send AJAX request to apply the preset without form submission
    fetch('/patients/dashboard/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `action=apply_preset&preset_id=${presetId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.textContent = "‚úÖ Success";
                saveMessage.style.display = "block";
                setTimeout(() => {
                    saveMessage.style.display = "none";
                }, 3000);
            }

            console.log('Preset applied successfully via AJAX: Preset ID', presetId);
                
                // Update points fields from preset data
                if (data.preset) {
                    console.log("üîç DEBUG: Updating points fields from preset data");
                    
                    // Points field mapping (corrected element IDs)
                    const pointsFieldMapping = {
                        'points_per_consecutive_attendance': 'consecutive-points-display',
                        'points_per_cancellation': 'cancellations-points-display',
                        'points_per_dna': 'dna-points-display',
                        'points_per_unpaid_invoice': 'unpaid-invoices-points-display',
                        'points_per_referral': 'referrer-points-display',
                    };
                    
                    // Update each points field
                    Object.keys(pointsFieldMapping).forEach(field => {
                        const elementId = pointsFieldMapping[field];
                        const hiddenId = elementId.replace('-points-display', '-hidden');
                        
                        const display = document.getElementById(elementId);
                        const hidden = document.getElementById(hiddenId);
                        
                        if (display && data.preset[field] !== undefined) {
                            display.textContent = data.preset[field];
                            if (hidden) {
                                hidden.value = data.preset[field];
                            }
                            console.log(`‚úÖ Updated points ${field}: ${data.preset[field]}`);
                        } else {
                            console.log(`‚ùå Could not update ${field}: element ${elementId} not found or data missing`);
                        }
                    });
                    
                    // Update brackets if included in response
                    if (data.preset.age_brackets) {
                        updateAgeBracketsDisplay(data.preset.age_brackets);
                        console.log("‚úÖ Updated age brackets from preset");
                    }
                    
                    if (data.preset.spend_brackets) {
                        updateSpendBracketsDisplay(data.preset.spend_brackets);
                        console.log("‚úÖ Updated spend brackets from preset");
                    }
                    
                    console.log("‚úÖ All points and brackets updated from preset data");
// Update slider values from preset data
                    console.log("üîç DEBUG: Updating slider values from preset data");
                    
                    const sliderMapping = {
                        'future_appointments_weight': 'future_appointments_value',
                        'age_demographics_weight': 'age_demographics_value', 
                        'yearly_spend_weight': 'yearly_spend_value',
                        'consecutive_attendance_weight': 'consecutive_attendance_value',
                        'referrer_score_weight': 'referrer_score_value',
                        'referrer_score_weight': 'referrer_score_weight_value',
                        'cancellations_weight': 'cancellations_weight_value',
                        'dna_weight': 'dna_weight_value',
                        'unpaid_invoices_weight': 'unpaid_invoices_weight_value',
                        'open_dna_invoice_weight': 'open_dna_invoice_weight_value'
                    };
                    
                    // Update each slider value display and actual slider
                    Object.keys(sliderMapping).forEach(field => {
                        const valueElementId = sliderMapping[field];
                        const valueElement = document.getElementById(valueElementId);
                        
                        // Also update the actual slider input
                        let sliderElement = null;
                        if (field === 'referrer_score_weight') {
                            sliderElement = document.getElementById('referrer-slider');
                        } else {
                            sliderElement = document.querySelector(`input[name="${field}"]`);
                        }
