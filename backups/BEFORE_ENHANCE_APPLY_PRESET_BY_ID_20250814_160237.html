<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        /* Likability Slider with Gradient and Neutral Mark */
        #likability-slider {
            background: linear-gradient(to right, #ff6b6b 0%, #feca57 50%, #48cae4 100%);
            border-radius: 3px;
            height: 6px;
        }
        
        #likability-slider::-webkit-slider-track {
            background: linear-gradient(to right, #ff6b6b 0%, #feca57 50%, #48cae4 100%);
            border-radius: 3px;
            height: 6px;
        }
        
        #likability-slider::-moz-range-track {
            background: linear-gradient(to right, #ff6b6b 0%, #feca57 50%, #48cae4 100%);
            border-radius: 3px;
            height: 6px;
        }
        
        /* Neutral mark container */
        .likability-container {
            position: relative;
            display: inline-block;
        }
        
        /* Neutral mark at center */
        .neutral-mark {
            position: absolute;
            top: 7px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background: #333;
            border-radius: 1px;
            pointer-events: none;
            z-index: 10;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RatedApp Dashboard</title>
    <style>
        .slider-container { margin-bottom: 1rem; }
        .slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .slider { width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; opacity: 0.7; transition: opacity 0.2s; cursor: pointer; }
        .slider:hover { opacity: 1; }
        .slider::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #667eea; cursor: pointer; }
        .slider.positive::-webkit-slider-thumb { background: #28a745; }
        .slider.negative::-webkit-slider-thumb { background: #dc3545; }        * { margin: 0; padding: 0; box-sizing: border-box; }
        .info-icon {
            margin-left: 6px;
            cursor: help;
            font-size: 0.9rem;
            color: #6c757d;
            opacity: 0.8;
        }
        .info-icon:hover {
            color: #007bff;
            opacity: 1;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto; }
        .logo { font-size: 1.5rem; font-weight: bold; }
        
        .main-container { 
            max-width: 1400px; 
            margin: 2rem auto; 
            padding: 0 2rem; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 2rem; 
            height: calc(100vh - 140px); 
        }
        
        .left-panel, .right-panel { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            padding: 2rem; 
            overflow-y: auto; 
        }
        
        .panel-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 2rem; 
            padding-bottom: 1rem; 
            border-bottom: 2px solid #e9ecef; 
        }
        
        .panel-title { font-size: 1.5rem; font-weight: 600; color: #2c3e50; }
        .panel-icon { font-size: 2rem; margin-right: 1rem; }
    
        
        /* LastPass blocking CSS */
        div[data-lastpass-icon-root] {
            display: none !important;
        }
        
        div[data-lastpass-root] {
            display: none !important;
        }
        
        span[data-lastpass-root] {
            display: none !important;
        }
        
        /* Block LastPass overlay */
        .LPOverlay {
            display: none !important;
        }
        
        /* Block LastPass icon container */
        [data-lastpass-icon-root="true"] {
            display: none !important;
        }
        
        /* Minimal LastPass blocking - no layout interference */
        #unpaid-invoices-input {
            /* Remove positioning overrides that break inline flow */
        }
        
        #unpaid-invoices-points-display {
            /* Remove display overrides that affect box size */
        }
        </style>

    <meta name="format-detection" content="telephone=no, email=no, address=no">
    </head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">üè• RatedApp Dashboard</div>
            <div>Sports Medicine Clinic</div>
        </div>
    </header>

    <div class="main-container">
        <div class="left-panel">
            <div class="panel-header">
                <span class="panel-icon">‚öôÔ∏è</span>
                <h2 class="panel-title">Scoring Configuration</h2>
            </div>
            <form method="get" action="{% url 'unified_dashboard' %}" onsubmit="return handleFormSubmit(event)">
    {% csrf_token %}
    <div class="behavior-group">
        <h4 style="margin-bottom: 1.5rem;">Positive Behaviours</h4>
        <div class="slider-container">
            <div class="slider-label">
                <span>üìÖ Future Appointment <span class="info-icon" title="Slider indicates max points for patients with an upcoming appointment booked.">‚ìò</span></span>
                <span id="future_appointments_value">{{ active_config.future_appointments_weight }}</span>
            </div>
            <input type="range" name="future_appointments_weight" class="slider positive" min="0" max="100" value="{{ active_config.future_appointments_weight }}" oninput="updateSliderValue('future_appointments', this.value)">
        </div>

        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>üë§ Age Demographics <span class="info-icon" title="Slider indicates the max points available to a patient based on their age. The percentage inside the Age bracket will dictate the amount of points allocated from the slider.">‚ìò</span></span>
                <span id="age_demographics_value">{{ active_config.age_demographics_weight }}</span>
            </div>
            <input type="range" name="age_demographics_weight" class="slider positive" min="0" max="100" value="{{ active_config.age_demographics_weight }}" oninput="updateSliderValue('age_demographics', this.value)">
        </div>

        <div id="age-brackets-header" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="var content=document.getElementById('age-brackets-content'); var arrow=this.children[1]; if(content.style.display==='none'){content.style.display='block'; arrow.textContent='‚ñ≤';}else{content.style.display='none'; arrow.textContent='‚ñº';}"><span style="font-size: 0.9rem; font-weight: normal;">Age Brackets <span class="info-icon" title="The percentage indicates the amount of slider value that is given if a patient falls in the specified, corresponding age ranges.">‚ìò</span></span><span style="float: right;">‚ñº</span></div>
        <div id="age-brackets-content" style="display: none; padding: 10px; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;">
            <div id="age-brackets-list" style="display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 8px;">
        <!-- Screen-only age brackets will be added here -->
        {% for bracket in age_brackets %}<div style="display: flex; flex-direction: column; align-items: flex-start;"><div style="display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;"><div style="padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;">{{ bracket.min_age }}-{{ bracket.max_age }}</div><div style="padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;">{{ bracket.percentage }}%</div></div><div style="display: flex; gap: 4px; margin-top: 2px;"><button onclick="deleteAgeBracket({{ bracket.id }})" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Delete</button></div></div>{% endfor %}<button onclick="addNewAgeBracket()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; cursor: pointer; height: 67%; align-self: flex-start;">+ ADD</button></div>
        </div>    </div>



        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>üí∞ Yearly Spend <span class="info-icon" title="The slider will indicate the max value a patient can receive based on their year-to-date spending. Bracket percentages will indicate how much value the slider allocates.">‚ìò</span></span>
                <span id="yearly_spend_value">{{ active_config.yearly_spend_weight }}</span>
            </div>
            <input type="range" name="yearly_spend_weight" class="slider positive" min="0" max="100" value="{{ active_config.yearly_spend_weight }}" oninput="updateSliderValue('yearly_spend', this.value)">
        </div>

        <div id="spend-brackets-header" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="var content=document.getElementById('spend-brackets-content'); var arrow=this.children[1]; if(content.style.display==='none'){content.style.display='block'; arrow.textContent='‚ñ≤';}else{content.style.display='none'; arrow.textContent='‚ñº';}"><span style="font-size: 0.9rem; font-weight: normal;">Spend Brackets <span class="info-icon" title="The percentage indicates the amount of slider value that is given if a patient falls in the specified, corresponding year-to-date spend range.">‚ìò</span></span><span style="float: right;">‚ñº</span></div>
        <div id="spend-brackets-content" style="display: none; padding: 10px; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;">
            <div id="spend-brackets-list" style="display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap;">{% for bracket in spend_brackets %}<div style="display: flex; flex-direction: column; align-items: flex-start;"><div style="display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;"><div style="padding: 4px 12px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;">{% if bracket.max_spend >= 999999.99 %}{{ bracket.min_spend|floatformat:0 }}+{% else %}{{ bracket.min_spend|floatformat:0 }}-{{ bracket.max_spend|floatformat:0 }}{% endif %}</div><div style="padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;">{{ bracket.percentage }}%</div></div><div style="display: flex; gap: 4px; margin-top: 2px;"><button onclick="deleteSpendBracket({{ bracket.id }})" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Delete</button></div></div>{% endfor %}<button onclick="addNewSpendBracket()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 0.8rem; cursor: pointer; height: 67%; align-self: flex-start;">+ ADD</button></div>
        </div>

        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>‚úÖ Consecutive Attendance <span class="info-icon" title="This will take the number of consecutive appointments (not broken by a cancellation or DNA) a patient has had and multiply them by the number in the box, giving a score. The slider will indicate the maximum score a patient can receive.">‚ìò</span><span id="consecutive-points-display" style="margin-left: 12px; padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem; font-weight: 600; color: #333; min-width: 60px; text-align: center;">{{ active_config.points_per_consecutive_attendance }}</span><button type="button" id="edit-consecutive-btn" onclick="editConsecutivePoints()" style="margin-left: 4px; background: #007bff; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Edit</button><input type="number" id="consecutive-input" min="0" max="100" value="{{ active_config.points_per_consecutive_attendance }}" style="margin-left: 8px; width: 50px; padding: 2px 4px; border: 1px solid #ced4da; border-radius: 2px; font-size: 0.8rem; display: none;"><button type="button" id="save-consecutive-btn" onclick="saveConsecutivePoints()" style="margin-left: 4px; background: #28a745; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer; display: none;">Save</button><input type="hidden" name="points_per_consecutive_attendance" id="consecutive-hidden" value="{{ active_config.points_per_consecutive_attendance }}"></span>
                <span id="consecutive_attendance_value">{{ active_config.consecutive_attendance_weight }}</span>
            </div>
            <input type="range" name="consecutive_attendance_weight" class="slider positive" min="0" max="100" value="{{ active_config.consecutive_attendance_weight }}" oninput="updateSliderValue('consecutive_attendance', this.value)">
        </div>

    <div class="behavior-group" style="margin-top: 2rem;">
        <h4 style="margin-bottom: 1.5rem;">Negative Behaviours</h4>
        
        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>‚ùå Cancellations <span class="info-icon" title="This will take the number of cancelled appointments and multiply them by the number in the box, giving a penalty score. The slider will indicate the maximum penalty score a patient can receive.">‚ìò</span><span id="cancellations-points-display" style="margin-left: 12px; padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem; font-weight: 600; color: #333; min-width: 60px; text-align: center;">{{ active_config.points_per_cancellation }}</span><button type="button" id="edit-cancellations-btn" onclick="editCancellationsPoints()" style="margin-left: 4px; background: #007bff; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Edit</button><input type="number" id="cancellations-input" min="0" max="100" value="{{ active_config.points_per_cancellation }}" style="margin-left: 8px; width: 50px; padding: 2px 4px; border: 1px solid #ced4da; border-radius: 2px; font-size: 0.8rem; display: none;"><button type="button" id="save-cancellations-btn" onclick="saveCancellationsPoints()" style="margin-left: 4px; background: #28a745; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer; display: none;">Save</button><input type="hidden" name="points_per_cancellation" id="cancellations-hidden" value="{{ active_config.points_per_cancellation }}"></span>
                <span id="cancellations_weight_value">{{ active_config.cancellations_weight }}</span>
            </div>
            <input type="range" name="cancellations_weight" class="slider negative" min="0" max="100" value="{{ active_config.cancellations_weight }}" oninput="updateSliderValue('cancellations_weight', this.value)">
        </div>
        
        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>üö´ DNA - Did Not Arrive <span class="info-icon" title="This will take the number of appointments marked Did Not Arrive and multiply them by the number in the box, giving a penalty score. The slider will indicate the maximum penalty score a patient can receive.">‚ìò</span><span id="dna-points-display" style="margin-left: 12px; padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem; font-weight: 600; color: #333; min-width: 60px; text-align: center;">{{ active_config.points_per_dna }}</span><button type="button" id="edit-dna-btn" onclick="editDNAPoints()" style="margin-left: 4px; background: #007bff; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Edit</button><input type="number" id="dna-input" min="0" max="100" value="{{ active_config.points_per_dna }}" style="margin-left: 8px; width: 50px; padding: 2px 4px; border: 1px solid #ced4da; border-radius: 2px; font-size: 0.8rem; display: none;"><button type="button" id="save-dna-btn" onclick="saveDNAPoints()" style="margin-left: 4px; background: #28a745; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer; display: none;">Save</button><input type="hidden" name="points_per_dna" id="dna-hidden" value="{{ active_config.points_per_dna }}"></span>
                <span id="dna_weight_value">{{ active_config.dna_weight }}</span>
            </div>
            <input type="range" name="dna_weight" class="slider negative" min="0" max="100" value="{{ active_config.dna_weight }}" oninput="updateSliderValue('dna_weight', this.value)">
        </div>
        
        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>üí∏ Unpaid Invoices <span class="info-icon" title="This will take the number of unpaid invoices and multiply them by the number in the box, giving a penalty score. The slider will indicate the maximum penalty score a patient can receive.">‚ìò</span><span id="unpaid-invoices-points-display" style="margin-left: 12px; padding: 6px 12px; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem; font-weight: 600; color: #333; min-width: 60px; text-align: center;">{{ active_config.points_per_unpaid_invoice }}</span><button type="button" id="edit-unpaid-invoices-btn" onclick="editUnpaidInvoicesPoints()" style="margin-left: 4px; background: #007bff; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Edit</button><input type="number" id="unpaid-invoices-input" min="0" max="100" data-lpignore="true" autocomplete="off" data-form-type="other" value="{{ active_config.points_per_unpaid_invoice }}" style="margin-left: 8px; width: 50px; padding: 2px 4px; border: 1px solid #ced4da; border-radius: 2px; font-size: 0.8rem; display: none;"><button type="button" id="save-unpaid-invoices-btn" onclick="saveUnpaidInvoicesPoints()" style="margin-left: 4px; background: #28a745; color: white; border: none; padding: 5px 7px; border-radius: 2px; font-size: 0.7rem; cursor: pointer; display: none;">Save</button><input type="hidden" name="points_per_unpaid_invoice" id="unpaid-invoices-hidden" data-lpignore="true" autocomplete="off" value="{{ active_config.points_per_unpaid_invoice }}">
    
    <!-- Hidden Bracket Data Fields - Added for simplified bracket approach like sliders -->
    <input type="hidden" id="age-brackets-data" name="age_brackets_data" value="">
    <input type="hidden" id="spend-brackets-data" name="spend_brackets_data" value=""></span>
                <span id="unpaid_invoices_weight_value">{{ active_config.unpaid_invoices_weight }}</span>
            </div>
            <input type="range" name="unpaid_invoices_weight" class="slider negative" data-lpignore="true" min="0" max="100" value="{{ active_config.unpaid_invoices_weight }}" oninput="updateSliderValue('unpaid_invoices_weight', this.value)">
        </div>
        
        <div class="slider-container" data-lpignore="true" style="margin-top: 1.5rem;">
            <div class="slider-label">
                <span>üìã Open DNA Invoice <span class="info-icon" title="The slider will indicate a penalty score only if the patient has any unpaid Did Not Arrive invoice/s.">‚ìò</span></span>
                <span id="open_dna_invoice_weight_value">{{ active_config.open_dna_invoice_weight }}</span>
            </div>
            <input type="range" name="open_dna_invoice_weight" class="slider negative" min="0" max="100" value="{{ active_config.open_dna_invoice_weight }}" oninput="updateSliderValue('open_dna_invoice_weight', this.value)">
        </div>
    </div>
<!-- Button Row Container -->
    <div style="display: flex; align-items: center; gap: 20px; justify-content: flex-start; margin-top: 20px;">
            <button type="button" onclick="handleFormSubmit(event)" style="width: 160px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">Update Weights</button>
            <div id="save-message" style="display: none; color: #28a745; font-size: 0.9rem;">‚úÖ Success</div>
        </div>

        <div class="scoring-presets-accordion" style="margin-top: 30px; width: 100%; border: 1px solid #dee2e6; border-radius: 4px; background: #f8f9fa;">
            <div class="accordion-header" onclick="toggleScoringPresets()" style="height: 45px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #f8f9fa; border-radius: 4px 4px 0 0;">
                <span class="accordion-title" style="font-size: 0.9rem;">‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>{{ active_config.name|default:'Default' }}</strong></span>
                <span class="center-buttons" style="display: flex; align-items: center; gap: 4px;"><button id="update-preset-btn" onclick="updateCurrentPreset()" style="background: #007bff; color: white; border: none; padding: 5px 12px; border-radius: 3px; font-size: 0.85rem; cursor: pointer;">Update</button><span class="info-icon" title="This button updates the existing, applied preset.">‚ìò</span></span>
                <span class="accordion-arrow" id="presets-arrow">‚ñº</span>
            </div>
            <div class="accordion-content" id="scoring-presets-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #f8f9fa; border-radius: 0 0 4px 4px;">
                <div class="presets-container" style="padding: 15px;">
                    <div class="preset-line-1" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 0.9rem;">Choose Saved Preset:</label>
                            <select id="preset-dropdown" style="width: 173px; height: 32px; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                            <option value="">Select preset...</option>
                            <option value="clinical">üè• Clinical Standard</option>
                            <option value="sports">üèÉ Sports Medicine</option>
                            <option value="general">üíº General Practice</option>
                        </select>
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 8px;">
                            <button type="button" id="display-preset-btn" onclick="displayPreset()" style="background: #007bff; color: white; border: none; padding: 5px 11px; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">Display</button>
                            <button type="button" id="apply-preset-btn" onclick="(() => {
        const dropdown = document.getElementById('preset-dropdown');
        if (dropdown && dropdown.value) {
            const presetId = dropdown.value;
            const presetName = dropdown.options[dropdown.selectedIndex].text;
            applyPresetById(presetId, presetName);
        } else {
            alert('Please select a preset first');
        }
    })()" style="background: #007bff; color: white; border: none; padding: 5px 11px; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">Apply</button>
                            <button type="button" id="delete-preset-btn" onclick="deletePreset()" style="background: #dc3545; color: white; border: none; padding: 5px 11px; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">Delete</button>
                        </div>
                    </div>
                    
                    <div class="preset-line-2" style="display: flex; align-items: center; gap: 10px; min-width: 600px; flex-wrap: nowrap;">
                        <button type="button" id="create-preset-btn" onclick="toggleCreateForm()" style="background: #28a745; color: white; border: none; padding: 5px 11px; border-radius: 4px; font-size: 0.9rem; cursor: pointer;; white-space: nowrap; min-width: 120px">Create Preset</button>
                        
                        <div id="create-form" style="display: none; margin-left: 10px; white-space: nowrap; min-width: 500px;">

                            <input type="text" id="preset-name" placeholder="Preset name" style="width: 120px; height: 28px; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; margin-right: 10px;">
                            

                            <input type="text" id="preset-description" placeholder="Description (optional)" style="width: 120px; height: 28px; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; margin-right: 10px;">
                            
                            <button onclick="saveNewPreset()" style="background: #28a745; color: white; border: none; padding: 5px 8px; border-radius: 4px; font-size: 0.9rem; cursor: pointer; margin-right: 5px;">Save</button>
                            <button onclick="cancelCreateForm()" style="background: #6c757d; color: white; border: none; padding: 5px 8px; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                <span class="panel-icon">üë•</span>
                <h2 class="panel-title">Patient Behavior Cards</h2>
            </div>
            <!-- COMPACT PATIENT SEARCH SECTION -->
            <div class="patient-cards-container" style="height: 100%; display: flex; flex-direction: column;">
                
                <!-- Patient Search Form - Compact (40px) -->
                <div class="patient-search-section" style="width: 66.67%; flex-shrink: 0; margin-bottom: 10px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="patient-search-input" placeholder="Search by name or ID..." 
                               style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                        <button type="button" id="search-patient-btn" onclick="searchPatients()" 
                                style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer;">
                            Search
                        </button>
                    </div>
                </div>
                
                <!-- Search Results - Scrollable (120px max) -->
                <div class="search-results-section" style="flex-shrink: 0; max-height: 120px; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 4px; display: none;" id="search-results-container">
                    <div class="search-results-header" style="padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 600; font-size: 0.85rem;">
                        Search Results (<span id="results-count">0</span> found)
                    </div>
                    <div class="search-results-list" id="search-results-list" style="max-height: 80px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                </div>
                
                <!-- PLACEHOLDER FOR NEXT STAGES -->
                <!-- Selected Patient Header - Compact (30px) -->
                <div class="selected-patient-header" style="flex-shrink: 0; padding: 8px 12px; background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 4px; margin-bottom: 10px; display: none;" id="selected-patient-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 0.9rem;" id="selected-patient-name">No patient selected</span>
                        <span style="font-size: 0.8rem; color: #666;" id="selected-patient-id">ID: -</span>
                    </div>
                </div>
                
                <!-- Behavior Cards - Scrollable Main Content -->
                <div class="behavior-cards-section" style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; padding: 10px; display: none;" id="behavior-cards-container">
                    
                    <!-- Likability Slider - Compact (35px) -->
                    <!-- Open DNA Invoice - Compact Display Only (35px) -->
                    <div class="compact-behavior-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 600; font-size: 0.85rem; color: #dc3545;">üìã Open DNA Invoices</span>
                                <span style="font-size: 0.75rem; color: #666;">0 open DNA invoices</span>
                            </div>
                            <span style="font-size: 0.8rem; color: #dc3545; font-weight: 600;">0</span>
                        </div>
                    </div>
                    
                    <div class="compact-behavior-card" style="margin-bottom: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; font-size: 0.85rem; color: #27ae60;">üòä Likability</span>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="likability-container"><div class="neutral-mark"></div><input type="range" id="likability-slider" min="-100" max="100" value="0" 
                                       style="width: 320px; height: 6px;" disabled></div>
                                <span id="likability-value" style="min-width: 45px; text-align: center; font-size: 0.8rem; font-weight: 600;">0</span>
                                <button type="button" id="edit-likability-btn" onclick="editLikability()" 
                                        style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer;">
                                    Edit
                                </button>
                                <button type="button" id="save-likability-btn" onclick="saveLikability()" 
                                        style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 3px; font-size: 0.7rem; cursor: pointer; display: none;">
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Unlikability Slider - Compact (35px) -->
                    
                    <!-- Additional Behavior Cards Placeholder -->
                    <div class="additional-behaviors" id="additional-behaviors-container">
                        <p style="text-align: center; color: #666; font-size: 0.85rem; margin: 20px 0;">
                            Additional behavior cards will be added in Stage 2
                        </p>
                    </div>
                    
                </div>
                
            </div>
        </div>
    </div>
<script>

// Global flag to prevent form submission during delete operations
window.deleteOperationInProgress = false;

// Store button reference globally for reliable access
let currentAddButton = null;

// Show success message if page was loaded after form submission

function updateSliderValue(sliderId, value) {
    document.getElementById(sliderId + "_value").textContent = value;
}

function handleFormSubmit(event) {
    // Prevent form submission during delete operations
    if (window.deleteOperationInProgress) {
        console.log('Form submission blocked - delete operation in progress');
        return false;
    }

    event.preventDefault();
    const form = document.querySelector('form[method="get"]');
    
    // Sync current screen data to hidden fields before submission
    console.log("üîÑ Syncing bracket data before form submission");
    updateAgeBracketsData();
    updateSpendBracketsData();
    console.log("‚úÖ Bracket data synced successfully");

    const formData = new FormData(form);
    
    // Ensure CSRF token is included
    const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.set('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Only add preset_id and apply_preset action if this is an Apply Preset call
    // Check if this form submission is from Apply Preset by looking for a global flag
    if (window.applyPresetInProgress && window.selectedPresetValue) {
        formData.append('preset_id', window.selectedPresetValue);
        formData.append('action', 'apply_preset');
        console.log('Apply Preset: Added preset_id and action to form data');
    }
    
    // DEBUG: Show what Apply button sends to Django
    console.log("üîç APPLY BUTTON DEBUG - FormData contents:");
    console.log(Array.from(formData.entries()));
    console.log("üîç Does Apply button send action parameter?", formData.get('action'));
    
    fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": csrfToken || form.querySelector('[name=csrfmiddlewaretoken]')?.value,
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.style.display = "block";
                setTimeout(() => saveMessage.style.display = "none", 1000);
            }

            // Update accordion header (if needed)
            const accordionTitle = document.querySelector('.accordion-title');
            if (accordionTitle) {
                // Header update removed - should only happen for Update Weights button
            }
        }
    })
    .catch(error => {
        console.error("AJAX Error:", error);
        alert("Error submitting form. Please try again.");
    });
    return false;
}


// üõ°Ô∏è BULLETPROOF BRACKET PARSING FUNCTION
function safeParseBracket(element, type = 'bracket') {
    // Safety check: element exists and has proper structure
    if (!element?.children?.[0]?.children?.[0] || !element?.children?.[0]?.children?.[1]) {
        console.warn(`‚ö†Ô∏è Invalid ${type} structure:`, element);
        return null;
    }
    
    const rangeText = element.children[0].children[0].textContent?.trim();
    const percentText = element.children[0].children[1].textContent?.trim();
    
    // Validate extracted data
    if (!rangeText || !percentText) {
        console.warn(`‚ö†Ô∏è Missing ${type} data:`, {rangeText, percentText});
        return null;
    }
    
    // Additional validation for percentage
    const percentage = parseInt(percentText.replace('%', ''));
    if (isNaN(percentage) || percentage < 0 || percentage > 100) {
        console.warn(`‚ö†Ô∏è Invalid ${type} percentage:`, percentText);
        return null;
    }
    
    return {
        rangeText: rangeText,
        percentText: percentText,
        percentage: percentage,
        element: element
    };
}

function deleteAgeBracket(bracketId) {
    if (confirm("Are you sure you want to delete this age bracket?")) {
        // Remove from DOM immediately - save to database when 'Update Preset' is pressed
        // Use event.target to get the clicked button directly (works for all bracket types)
        const button = event.target;
        if (button && button.parentElement && button.parentElement.parentElement) {
            button.parentElement.parentElement.remove();
            console.log('Removed age bracket from display (will save when Update Preset pressed)');
        }
    }

        
        // Auto-sync bracket data with hidden field
        updateAgeBracketsData();}// Prevent double-clicks
function addNewAgeBracket() {
    console.log("DEBUG: addNewAgeBracket function called!");
    
    const addButton = document.querySelector("button[onclick=\"addNewAgeBracket()\"]");
    if (!addButton) {        console.error("Add button not found!");
        return;
    }
    
    // Store button reference globally for reliable access
    currentAddButton = addButton;
    // Store original onclick for restoration
    window.originalAgeButtonOnclick = addButton.onclick;
    
    // Create input form
    const newBracketForm = document.createElement("div");
    newBracketForm.id = "new-bracket-form";
    newBracketForm.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 4px; padding: 8px; border: 1px solid #007bff; border-radius: 3px; background: #f8f9fa; font-size: 0.8rem;">
            <div style="display: flex; gap: 4px; align-items: center;">
                <input type="number" id="new_min_age" placeholder="Min" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="120">
                <span>-</span>
                <input type="number" id="new_max_age" placeholder="Max" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="999">
                <input type="number" id="new_percentage" placeholder="%" style="width: 40px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="100">
            </div>
            <div style="display: flex; gap: 4px; margin-top: 2px;">
                <button onclick="cancelNewAgeBracket()" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Cancel</button>
            </div>
        </div>
    `;
    
    // Replace add button with input form
    addButton.parentElement.insertBefore(newBracketForm, addButton);
    addButton.textContent = "SAVE";
    
    // Change button onclick to save function
    addButton.onclick = function() { saveNewAgeBracket(); };
    
    // Focus on first input
    document.getElementById("new_min_age").focus();

        
        // Auto-sync bracket data with hidden field
        updateAgeBracketsData();}
function saveNewAgeBracket() {
    console.log("DEBUG: saveNewAgeBracket function called!"); // ADD THIS FIRST
    
    // Prevent double-clicks
    if (window.savingInProgress) {
        console.log("DEBUG: Saving already in progress, returning"); // ADD THIS
        return;
    }
    window.savingInProgress = true;
    
    const minAge = document.getElementById('new_min_age').value;
    const maxAge = document.getElementById('new_max_age').value;
    const percentage = document.getElementById('new_percentage').value;
    
    console.log("DEBUG: Form values:", {minAge, maxAge, percentage}); // EXISTING
    console.log("DEBUG: Input elements found:", {
        minAgeElement: document.getElementById('new_min_age'),
        maxAgeElement: document.getElementById('new_max_age'),
        percentageElement: document.getElementById('new_percentage')
    }); // ADD THIS

    // Validation
    if (!minAge || !maxAge || !percentage) {
        alert('Please fill in all fields');
        window.savingInProgress = false;
        return;
    }
    
    // Send AJAX request to backend
    const formData = new FormData();
    formData.append("action", "add_age_bracket");
    formData.append("min_age", minAge);
    formData.append("max_age", maxAge);
    formData.append("percentage", percentage);
    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);
    
    console.log("DEBUG: FormData being sent:", Array.from(formData.entries())); // ADD THIS
    
    fetch('/patients/dashboard/', {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => {
        console.log("DEBUG: Response status:", response.status); // ADD THIS
        return response.json();
    })
    .then(data => {
        console.log("DEBUG: Response data:", data);
        if (data.success) {
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.style.display = "block";
                setTimeout(() => saveMessage.style.display = "none", 1000);
            }
            
            // Add new bracket to DOM immediately in correct numerical position
            const newBracketHtml = `
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <div style="display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;">
                        <div style="padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500;">${minAge}-${maxAge}</div>
                        <div style="padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;">${percentage}%</div>
                    </div>
                    <div style="display: flex; gap: 4px; margin-top: 2px;">
                        <button onclick="deleteAgeBracket('temp-${Date.now()}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Delete</button>
                    </div>
                </div>
            `;
            
            // Use the known container directly
            const bracketsContainer = document.getElementById('age-brackets-content');
            console.log("DEBUG: Using direct container:", bracketsContainer);
            
            if (bracketsContainer) {
                console.log("DEBUG: Container children count:", bracketsContainer.children.length);
                
                // Debug existing bracket structure
                for (let i = 0; i < bracketsContainer.children.length; i++) {
                    const child = bracketsContainer.children[i];
                    console.log(`DEBUG: Child ${i}:`, child.tagName, child.className, child.innerHTML);
                }
                
                // Find existing brackets with proper age format for ordering
                const existingBrackets = [];
                
                // Since all brackets are in one container, we need to parse them differently
                const containerHTML = bracketsContainer.innerHTML;
                
                // Use regex to find all age bracket patterns in the HTML
                const bracketMatches = containerHTML.match(/font-weight: 500;">(\d+-\d+)<\/div>/g);
                
                if (bracketMatches) {
                    bracketMatches.forEach(match => {
                        const ageMatch = match.match(/(\d+)-(\d+)/);
                        if (ageMatch) {
                            const minAge = parseInt(ageMatch[1]);
                            console.log("DEBUG: Found existing bracket via regex:", ageMatch[0], "minAge:", minAge);
                            existingBrackets.push({
                                minAge: minAge,
                                ageText: ageMatch[0]
                            });
                        }
                    });
                }
                
                // Sort existing brackets by minAge for proper comparison
                existingBrackets.sort((a, b) => a.minAge - b.minAge);
                
                console.log("DEBUG: Found", existingBrackets.length, "existing brackets with proper format");
                
                // Find correct position to insert (numerical order)
                const newMinAge = parseInt(minAge);
                
                for (let i = 0; i < existingBrackets.length; i++) {
                    console.log("DEBUG: Comparing new age", newMinAge, "with existing", existingBrackets[i].minAge);
                    
                    if (newMinAge < existingBrackets[i].minAge) {
                        console.log("DEBUG: Will insert before bracket:", existingBrackets[i].ageText);
                        break;
                    }
                }
                
                // Since the bracket is saved to database, just refresh to show correct order
                console.log("DEBUG: Bracket saved successfully, refreshing page to show correct order");
                
                // Show success message briefly then refresh
                const saveMessage = document.getElementById("save-message");
                if (saveMessage) {
                    saveMessage.style.display = "block";
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    // If no save message, refresh immediately
                }
                
                console.log("DEBUG: New bracket added to DOM in correct position");
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.log("DEBUG: Could not find age-brackets-content container");
            }
            
            // Silent success - remove form and reset button without page reload
            const form = document.getElementById('new-bracket-form');
            if (form) {
                form.remove();
                console.log("DEBUG: Form removed");
            }
            
            // Reset ADD button
            if (currentAddButton) {
                console.log("DEBUG: Resetting button");
                currentAddButton.textContent = '+ ADD';
                currentAddButton.style.background = '#28a745';
                currentAddButton.onclick = function() { addNewAgeBracket(); };
                console.log("DEBUG: Button reset complete");
            }
            
            // Reset saving flag
            window.savingInProgress = false;

       
            
            // Add the new bracket to the screen immediately
            const ageBracketsContainer = document.getElementById('age-brackets-list');
            if (ageBracketsContainer) {
                // Create the new bracket element
                const newBracketDiv = document.createElement('div');
                newBracketDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
                
                const bracketContent = document.createElement('div');
                bracketContent.style.cssText = 'display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;';
                
                const rangeDiv = document.createElement('div');
                rangeDiv.style.cssText = 'padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;';
                rangeDiv.textContent = minAge + '-' + maxAge;
                
                const percentDiv = document.createElement('div');
                percentDiv.style.cssText = 'padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;';
                percentDiv.textContent = percentage + '%';
                
                const deleteButtonDiv = document.createElement('div');
                deleteButtonDiv.style.cssText = 'display: flex; gap: 4px; margin-top: 2px;';
                
                const deleteButton = document.createElement('button');
                deleteButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = function() { deleteAgeBracket(data.bracket_id); };
                
                // Assemble the bracket
                bracketContent.appendChild(rangeDiv);
                bracketContent.appendChild(percentDiv);
                deleteButtonDiv.appendChild(deleteButton);
                newBracketDiv.appendChild(bracketContent);
                newBracketDiv.appendChild(deleteButtonDiv);
                
                // SCREEN-ONLY NUMERICAL ORDERING LOGIC
                // 1. Parse existing age brackets from DOM
                const existingAgeBrackets = [];
                const allBracketDivs = ageBracketsContainer.querySelectorAll('div[style*="flex-direction: column"]');
                
                allBracketDivs.forEach(bracketDiv => {
                    // Find the range text (e.g., "18-25")
                    const rangeDiv = bracketDiv.children[0]?.children[0]; // Use proper DOM navigation
                    if (rangeDiv && rangeDiv.textContent.includes('-')) {
                        const rangeText = rangeDiv.textContent.trim();
                        const rangeParts = rangeText.split('-');
                        const minAge = parseInt(rangeParts[0]);
                        
                        if (!isNaN(minAge)) {
                            existingAgeBrackets.push({
                                minAge: minAge,
                                element: bracketDiv
                            });
                        }
                    }
                });
                
                // 2. Sort existing brackets by minAge for comparison
                existingAgeBrackets.sort((a, b) => a.minAge - b.minAge);
                
                // 3. Find correct insertion position based on new bracket's minAge
                const newMinAge = parseInt(minAge);
                let insertPosition = null;
                
                // Find the first existing bracket with minAge greater than new bracket
                for (let i = 0; i < existingAgeBrackets.length; i++) {
                    if (newMinAge < existingAgeBrackets[i].minAge) {
                        insertPosition = existingAgeBrackets[i].element;
                        break;
                    }
                }
                
                // 4. Insert in correct numerical position
                if (insertPosition) {
                    // Insert before the bracket with higher minAge
                    ageBracketsContainer.insertBefore(newBracketDiv, insertPosition);
                    console.log('‚úÖ Inserted age bracket in numerical order before:', insertPosition.children[0]?.children[0]?.textContent || 'unknown');
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    // New bracket has highest minAge, insert before ADD button
                    const addButton = ageBracketsContainer.querySelector('button[onclick*="addNewAgeBracket"]');
                    if (addButton) {
                        ageBracketsContainer.insertBefore(newBracketDiv, addButton);
                        console.log('‚úÖ Inserted age bracket at end (highest minAge)');
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        ageBracketsContainer.appendChild(newBracketDiv);
                        console.log('‚úÖ Appended age bracket (no ADD button found)');
                    }
                }
                
                console.log('‚úÖ Added new bracket to screen:', minAge + '-' + maxAge, percentage + '%');
            }
                
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
            alert("Error adding age bracket: " + (data.error || "Unknown error"));
            window.savingInProgress = false;
        }
    })
    .catch(error => {
        console.error("AJAX Add Error:", error);
        console.error("Full error details:", error);
        alert("Error adding age bracket: " + error.message);
        window.savingInProgress = false; // Reset saving flag
    });
}

function cancelNewAgeBracket() {
    // Remove input form
    const form = document.getElementById("new-bracket-form");
    if (form) {
        form.remove();
    }
    
    // Reset ADD button
    if (currentAddButton) {
        currentAddButton.textContent = "+ ADD";
        currentAddButton.style.background = "#28a745";
        currentAddButton.onclick = function() { addNewAgeBracket(); };
    }
    
    window.savingInProgress = false;
}
// Spend Bracket Functions
function deleteSpendBracket(bracketId) {
    if (confirm("Are you sure you want to delete this spend bracket?")) {
        // Remove from DOM immediately - save to database when 'Update Preset' is pressed
        // Use event.target to get the clicked button directly (works for all bracket types)
        const button = event.target;
        if (button && button.parentElement && button.parentElement.parentElement) {
            button.parentElement.parentElement.remove();
            console.log('Removed spend bracket from display (will save when Update Preset pressed)');
        }
    }

        
        // Auto-sync bracket data with hidden field
        updateSpendBracketsData();}

// Preset Selection Helper Function
function getSelectedPresetId() {
    // Empty function first - test it exists
    const dropdown = document.getElementById('preset-dropdown');
    if (!dropdown) return null;
    // Validation: return null for empty or default selections
    const value = dropdown.value;
    if (!value || value === ''|| value.trim() === '') {
        return null;
    }
    return value;
}

function confirmPresetDeletion(presetName, isLastPreset) {
    // Protection: Cannot delete last remaining preset
    if (isLastPreset) {
        alert('Cannot delete the last remaining preset.');
        return false;
    }
    
    // Confirmation with preset name
    const message = 'Are you sure you want to delete the preset "' + presetName + '"?\n\nThis action cannot be undone.';
    return confirm(message);
}

function deletePreset() {
    // Set flag to prevent form submission during delete
    window.deleteOperationInProgress = true;
    console.log('Delete operation started - form submission blocked');

    try {
        console.log('Delete preset function called');
        // Step 3B: Get selected preset ID
        const presetId = getSelectedPresetId();
        if (!presetId) {
            console.error('No preset selected for deletion');
            return;
        }
        console.log('Selected preset ID for deletion:', presetId);

        // Step 3C: Get user confirmation for deletion
        const dropdown = document.getElementById('preset-dropdown');
        const presetName = dropdown.options[dropdown.selectedIndex].text;
        const isLastPreset = dropdown.options.length <= 1;
        
        const confirmed = confirmPresetDeletion(presetName, isLastPreset);
        if (!confirmed) {
            console.log('Preset deletion cancelled by user');
            return;
        }
        
        // STEP 1: Applied preset detection logic
        const currentAppliedPreset = document.querySelector('.accordion-title strong:last-of-type');
        const appliedPresetName = currentAppliedPreset ? currentAppliedPreset.textContent.trim() : '';
        const isDeletingAppliedPreset = (presetName === appliedPresetName);
        
        console.log('Preset to delete:', presetName);
        console.log('Currently applied preset:', appliedPresetName);
        console.log('Is deleting applied preset:', isDeletingAppliedPreset);
        console.log('User confirmed deletion, proceeding...')
        
        // STEP 2A: Second popup for applied preset deletion
        if (isDeletingAppliedPreset) {
            // Dynamic message based on backend fallback priority
            let fallbackMessage;
            if (presetName === 'Factory Settings') {
                fallbackMessage = 'You are deleting the currently applied preset "' + presetName + '".\n\nThe system will automatically revert to the next available preset to maintain functionality.\n\nProceed with deletion?';
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                fallbackMessage = 'You are deleting the currently applied preset "' + presetName + '".\n\nThe system will automatically revert to "Factory Settings" to maintain functionality.\n\nProceed with deletion?';
            }
            const secondConfirm = confirm(fallbackMessage);
            if (!secondConfirm) {
                console.log('Applied preset deletion cancelled at second popup');
                return;
            }
            console.log('Applied preset deletion confirmed at second popup');
        }

        // Step 3D: Send AJAX DELETE request to backend
        fetch("/patients/delete-preset/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "X-Requested-With": "XMLHttpRequest"
            },
            body: "action=delete_preset&preset_id=" + presetId
        })
        .then(response => response.json())
        .then(data => {
            console.log('AJAX response received:', data);
            console.log('DEBUG FRONTEND: data.was_active_preset_deleted =', data.was_active_preset_deleted);
            console.log('DEBUG FRONTEND: data.fallback_preset =', data.fallback_preset);
            if (data.fallback_preset) {
                console.log('DEBUG FRONTEND: fallback_preset.id =', data.fallback_preset.id);
                console.log('DEBUG FRONTEND: fallback_preset.name =', data.fallback_preset.name);
            }
            console.log('DEBUG FRONTEND: Current accordion header before update:', document.querySelector('.accordion-title').innerHTML);
            if (data.success) {
            
                console.log('Preset deleted successfully:', data);
                
                // STEP 2B: Show inline success message (replace alert)
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = '‚úÖ Success';
                    saveMessage.style.display = 'block';
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                        saveMessage.textContent = '‚úÖ Success'; // Reset to default
                    }, 3000);
                }
                
                // Remove deleted preset from dropdown
                const dropdown = document.getElementById('preset-dropdown');
                const deletedPresetId = presetId;
                
                // Find and remove the option
                for (let i = 0; i < dropdown.options.length; i++) {
                    if (dropdown.options[i].value === deletedPresetId) {
                        dropdown.remove(i);
                        console.log('Removed preset option:', deletedPresetId);
                        break;
                    }
                }
                
                // STEP 2C: Workflow branching based on applied preset detection
                if (isDeletingAppliedPreset) {
                    console.log('WORKFLOW 2: Applied preset deleted - updating header and values');
                    
                    // Handle fallback when active preset was deleted
                    if (data.was_active_preset_deleted && data.fallback_preset) {
                        console.log('Backend confirmed active preset deletion, switching to fallback:', data.fallback_preset.name);
                        
                        // Apply the fallback preset to update screen values
                        applyPresetById(data.fallback_preset.id, data.fallback_preset.name);
                        
                        // Update accordion header to show new active preset
                        // Update accordion header to show fallback preset (BOLD - new applied preset)
                        const accordionTitle = document.querySelector('.accordion-title');
                        if (accordionTitle && data.fallback_preset && data.fallback_preset.name) {
                            accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>${data.fallback_preset.name}</strong>`;
                            console.log('Accordion header updated to show fallback preset:', data.fallback_preset.name);
                        }
                        
                        // Select fallback preset in dropdown
                        for (let i = 0; i < dropdown.options.length; i++) {
                            if (dropdown.options[i].value === data.fallback_preset.id.toString()) {
                                dropdown.selectedIndex = i;
                                console.log('Selected fallback preset in dropdown:', data.fallback_preset.name);
                                break;
                            }
                        }
                        
                        // Auto-apply the fallback preset to load its values
                        console.log('Auto-applying fallback preset to maintain system functionality');
                        // Only auto-apply fallback if we deleted the active preset
                        if (data.was_active_preset_deleted && data.fallback_preset) {
                        }
                    }
                    
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.log('WORKFLOW 1: Non-applied preset deleted - no UI changes needed');
                    
                    // Handle dropdown selection after deletion (non-active preset deleted)
                    if (dropdown.options.length > 0) {
                        dropdown.selectedIndex = 0;  // Select first remaining preset
                        console.log('Selected first remaining preset');
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.log('No presets remaining in dropdown');
                        // Could add logic to create default preset or disable UI
                    }
                }
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.error('Backend error:', data.error || data.message);
                alert('Error: ' + (data.error || data.message || 'Failed to delete preset'));
            }
        })
        .catch(error => {
            console.error('AJAX error:', error);
            alert('Error deleting preset. Please try again.');
        });
    } catch (error) {
        console.error('Error in deletePreset:', error);
    }
    // Clear flag - delete operation complete
    window.deleteOperationInProgress = false;
    console.log('Delete operation completed - form submission re-enabled');

}

function addNewSpendBracket() {
    console.log("DEBUG: addNewSpendBracket function called!");
    
    const addButton = document.querySelector('button[onclick="addNewSpendBracket()"]');
    if (!addButton) {
        console.error("Add button not found!");
        return;
    }
    
    // Store button reference globally for reliable access
    currentAddButton = addButton;    
    // Store original onclick for restoration
    window.originalSpendButtonOnclick = addButton.onclick;
    
    // Create input form
    const newBracketForm = document.createElement('div');
    newBracketForm.id = 'new-bracket-form';
    newBracketForm.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 4px; padding: 8px; border: 1px solid #007bff; border-radius: 3px; background: #f8f9fa; font-size: 0.8rem;">
            <div style="display: flex; gap: 4px; align-items: center;">
                <input type="number" id="new-spend-min" placeholder="Min $" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" step="0.01" min="0">
                <span>-</span>
                <input type="number" id="new-spend-max" placeholder="Max $" style="width: 60px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" step="0.01" min="0">
                <input type="number" id="new-spend-percentage" placeholder="%" style="width: 40px; padding: 2px; border: 1px solid #ccc; border-radius: 2px;" min="0" max="100">
            </div>
            <div style="display: flex; gap: 4px; margin-top: 2px;">
                
                <button onclick="cancelNewSpendBracket()" style="background: #6c757d; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Cancel</button>
            </div>
        </div>
    `;
    
    // Replace add button with input form
    addButton.parentElement.insertBefore(newBracketForm, addButton);
    // Transform ADD button to SAVE button (like age brackets)
    addButton.textContent = 'SAVE';
    
    // Change button onclick to save function
    addButton.onclick = function() { saveNewSpendBracket(); };
    
    // Focus on first input
    document.getElementById('new-spend-min').focus();

        
        // Auto-sync bracket data with hidden field
        updateSpendBracketsData();}

    // BRACKET SYNCHRONIZATION FUNCTIONS - Added for simplified bracket approach like sliders
    function updateAgeBracketsData() {
        console.log('Updating age brackets data from display');
        const ageBrackets = [];
        const ageBracketElements = document.querySelectorAll('#age-brackets-content > div > div');
        
        ageBracketElements.forEach((element, index) => {
            try {
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                console.log('Skipping bracket element', index, '- invalid structure');
                return;
                }

                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                console.log('Skipping bracket element', index, '- invalid bracket content');
                return;
                }

                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    
                    // Parse range (e.g., "18-25" or "65+")
                    let minAge, maxAge;
                    if (rangeText.includes('+')) {
                        minAge = parseInt(rangeText.replace('+', ''));
                        maxAge = 999;
                    } else if (rangeText.includes('-')) {
                        const parts = rangeText.split('-');
                        minAge = parseInt(parts[0]);
                        maxAge = parseInt(parts[1]);
                    }
                    
                    // Parse percentage (e.g., "10%")
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    if (!isNaN(minAge) && !isNaN(maxAge) && !isNaN(percentage)) {
                        ageBrackets.push({
                            min_age: minAge,
                            max_age: maxAge,
                            percentage: percentage,
                            order: index + 1
                        });
                    }
                }
            } catch (error) {
                console.warn('Error parsing age bracket:', error);
            }
        });
        
        // Update hidden field
        const hiddenField = document.getElementById('age-brackets-data');
        if (hiddenField) {
            hiddenField.value = JSON.stringify(ageBrackets);
            console.log('Age brackets data updated:', ageBrackets.length, 'brackets');
        }
        
        return ageBrackets;
    }

    function updateSpendBracketsData() {
        console.log('Updating spend brackets data from display');
        const spendBrackets = [];
        const spendBracketElements = document.querySelectorAll('#spend-brackets-content > div > div');
        
        spendBracketElements.forEach((element, index) => {
            try {
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                console.log('Skipping bracket element', index, '- invalid structure');
                return;
                }

                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                console.log('Skipping bracket element', index, '- invalid bracket content');
                return;
                }

                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    
                    // Parse range (e.g., "$0-$1999" or "$5000+")
                    let minSpend, maxSpend;
                    const cleanRange = rangeText.replace(/[$,]/g, '');
                    
                    if (cleanRange.includes('+')) {
                        minSpend = parseFloat(cleanRange.replace('+', ''));
                        maxSpend = 999999.99;
                    } else if (cleanRange.includes('-')) {
                        const parts = cleanRange.split('-');
                        minSpend = parseFloat(parts[0]);
                        maxSpend = parseFloat(parts[1]);
                    }
                    
                    // Parse percentage (e.g., "15%")
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    if (!isNaN(minSpend) && !isNaN(maxSpend) && !isNaN(percentage)) {
                        spendBrackets.push({
                            min_spend: minSpend,
                            max_spend: maxSpend,
                            percentage: percentage,
                            order: index + 1
                        });
                    }
                }
            } catch (error) {
                console.warn('Error parsing spend bracket:', error);
            }
        });
        
        // Update hidden field
        const hiddenField = document.getElementById('spend-brackets-data');
        if (hiddenField) {
            hiddenField.value = JSON.stringify(spendBrackets);
            console.log('Spend brackets data updated:', spendBrackets.length, 'brackets');
        }
        
        return spendBrackets;
    }

    function syncAllBracketData() {
        console.log('Syncing all bracket data with hidden fields');
        updateAgeBracketsData();
        updateSpendBracketsData();
        console.log('All bracket data synchronized');
    }

function saveNewSpendBracket() {
    console.log("DEBUG: saveNewSpendBracket function called!");
    
    const minSpend = document.getElementById("new-spend-min").value;
    const maxSpend = document.getElementById("new-spend-max").value;
    const percentage = document.getElementById("new-spend-percentage").value;
    
    if (!minSpend || !percentage) {
        alert("Please fill in minimum spend and percentage");
        return;
    }
    
    const finalMaxSpend = maxSpend || "999999.99";
    
    fetch("/patients/dashboard/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
            "X-Requested-With": "XMLHttpRequest"
        },
        body: `action=add_spend_bracket&min_spend=${minSpend}&max_spend=${finalMaxSpend}&percentage=${percentage}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.style.display = "block";
                setTimeout(() => saveMessage.style.display = "none", 1000);
            }
            
                        
            // Add the new bracket to the screen with numerical ordering
            const spendBracketsContainer = document.getElementById('spend-brackets-list');
            if (spendBracketsContainer) {
                // Create the new bracket element (proper DOM creation)
                const newBracketDiv = document.createElement('div');
                newBracketDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
                
                const bracketContent = document.createElement('div');
                bracketContent.style.cssText = 'display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;';
                
                const rangeDiv = document.createElement('div');
                rangeDiv.style.cssText = 'padding: 4px 12px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;';
                rangeDiv.textContent = minSpend + '-' + finalMaxSpend;
                
                const percentDiv = document.createElement('div');
                percentDiv.style.cssText = 'padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;';
                percentDiv.textContent = percentage + '%';
                
                const deleteButtonDiv = document.createElement('div');
                deleteButtonDiv.style.cssText = 'display: flex; gap: 4px; margin-top: 2px;';
                
                const deleteButton = document.createElement('button');
                deleteButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = function() { deleteSpendBracket(data.bracket_id || 'temp-' + Date.now()); };
                
                // Assemble the bracket
                bracketContent.appendChild(rangeDiv);
                bracketContent.appendChild(percentDiv);
                deleteButtonDiv.appendChild(deleteButton);
                newBracketDiv.appendChild(bracketContent);
                newBracketDiv.appendChild(deleteButtonDiv);
                
                // NUMERICAL ORDERING LOGIC (adapted from working age brackets)
                // Parse existing spend brackets for numerical ordering
                const existingSpendBrackets = [];
                const allBracketDivs = spendBracketsContainer.querySelectorAll('div[style*="flex-direction: column"]');
                
                allBracketDivs.forEach(bracketDiv => {
                    // Find the range text (e.g., "200-999")
                    const rangeDiv = bracketDiv.children[0]?.children[0]; // Use proper DOM navigation
                    if (rangeDiv && rangeDiv.textContent.includes('-')) {
                        const rangeText = rangeDiv.textContent.trim();
                        // Split by - (no $ symbols to remove)
                        const rangeParts = rangeText.split('-');
                        const minSpendValue = parseInt(rangeParts[0]);
                        
                        if (!isNaN(minSpendValue)) {
                            existingSpendBrackets.push({
                                minSpend: minSpendValue,
                                element: bracketDiv
                            });
                        }
                    }
                });
                
                // Sort existing brackets by minSpend for comparison
                existingSpendBrackets.sort((a, b) => a.minSpend - b.minSpend);
                
                // Find correct insertion position based on new bracket's minSpend
                const newMinSpend = parseInt(minSpend);
                let insertPosition = null;
                
                // Find the first existing bracket with minSpend greater than new bracket
                for (let i = 0; i < existingSpendBrackets.length; i++) {
                    if (newMinSpend < existingSpendBrackets[i].minSpend) {
                        insertPosition = existingSpendBrackets[i].element;
                        break;
                    }
                }
                
                // Insert in correct numerical position
                if (insertPosition) {
                    // Insert before the bracket with higher minSpend
                    spendBracketsContainer.insertBefore(newBracketDiv, insertPosition);
                    console.log('‚úÖ Inserted spend bracket in numerical order before:', insertPosition.children[0]?.children[0]?.textContent || 'unknown');
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    // New bracket has highest minSpend, insert before ADD button
                    const addButton = spendBracketsContainer.querySelector('button[onclick*="addNewSpendBracket"]');
                    if (addButton) {
                        spendBracketsContainer.insertBefore(newBracketDiv, addButton);
                        console.log('‚úÖ Inserted spend bracket at end (highest minSpend)');
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        spendBracketsContainer.appendChild(newBracketDiv);
                        console.log('‚úÖ Appended spend bracket (no ADD button found)');
                    }
                }
                
                console.log('‚úÖ Added new spend bracket to screen:', '$' + minSpend + '-$' + finalMaxSpend, percentage + '%');
            }
            
            const addButton = document.querySelector('button[onclick="addNewSpendBracket()"]');
            
            const inputForm = document.querySelector('div[style*="border: 1px solid #007bff"]');
            if (inputForm) {
                inputForm.remove();
            }
            
            if (addButton) {
                addButton.textContent = "+ ADD";
                addButton.style.background = "#28a745";
                addButton.onclick = function() { addNewSpendBracket(); };
            }
                
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
            alert("Error adding spend bracket: " + (data.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error adding spend bracket");
    });
}
function cancelNewSpendBracket() {
    // Remove input form
    const inputForm = document.querySelector('div[style*="border: 1px solid #007bff"]');
    if (inputForm) {
        inputForm.remove();
    }
    // Reset ADD button
    if (currentAddButton) {
        currentAddButton.textContent = "+ ADD";
        currentAddButton.style.background = "#28a745";
        }
        currentAddButton.onclick = function() { addNewSpendBracket(); };
}
// Open spend brackets accordion if URL parameter exists
if (window.location.href.includes("spend_open=true")) {
    const content = document.getElementById("spend-brackets-content");
    const arrow = document.getElementById('spend-brackets-header')?.children[1]; // Safe: direct child access
    if (content && arrow) {
        content.style.display = "block";
        arrow.textContent = "‚ñ≤";
    }
}

function editConsecutivePoints() {
    document.getElementById("consecutive-points-display").style.display = "none";
    document.getElementById("edit-consecutive-btn").style.display = "none";
    document.getElementById("consecutive-input").style.display = "inline";
    document.getElementById("save-consecutive-btn").style.display = "inline-block";
    document.getElementById("consecutive-input").focus();
}

function saveConsecutivePoints() {
    const newValue = document.getElementById("consecutive-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("consecutive-points-display").textContent = newValue;
        document.getElementById("consecutive-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("consecutive-points-display").style.display = "inline";
        document.getElementById("edit-consecutive-btn").style.display = "inline-block";
        document.getElementById("consecutive-input").style.display = "none";
        document.getElementById("save-consecutive-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

function editCancellationsPoints() {
    document.getElementById("cancellations-points-display").style.display = "none";
    document.getElementById("edit-cancellations-btn").style.display = "none";
    document.getElementById("cancellations-input").style.display = "inline";
    document.getElementById("save-cancellations-btn").style.display = "inline-block";
    document.getElementById("cancellations-input").focus();
}

function saveCancellationsPoints() {
    const newValue = document.getElementById("cancellations-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("cancellations-points-display").textContent = newValue;
        document.getElementById("cancellations-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("cancellations-points-display").style.display = "inline";
        document.getElementById("edit-cancellations-btn").style.display = "inline-block";
        document.getElementById("cancellations-input").style.display = "none";
        document.getElementById("save-cancellations-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

function editDNAPoints() {
    document.getElementById("dna-points-display").style.display = "none";
    document.getElementById("edit-dna-btn").style.display = "none";
    document.getElementById("dna-input").style.display = "inline";
    document.getElementById("save-dna-btn").style.display = "inline-block";
    document.getElementById("dna-input").focus();
}

function saveDNAPoints() {
    const newValue = document.getElementById("dna-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("dna-points-display").textContent = newValue;
        document.getElementById("dna-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("dna-points-display").style.display = "inline";
        document.getElementById("edit-dna-btn").style.display = "inline-block";
        document.getElementById("dna-input").style.display = "none";
        document.getElementById("save-dna-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

function editUnpaidInvoicesPoints() {
    document.getElementById("unpaid-invoices-points-display").style.display = "none";
    document.getElementById("edit-unpaid-invoices-btn").style.display = "none";
    document.getElementById("unpaid-invoices-input").style.display = "inline";
    document.getElementById("save-unpaid-invoices-btn").style.display = "inline-block";
    document.getElementById("unpaid-invoices-input").focus();
}

function saveUnpaidInvoicesPoints() {
    const newValue = document.getElementById("unpaid-invoices-input").value;
    if (newValue < 0 || newValue > 100) return;
    
        // FRONTEND-ONLY: No backend contamination - only update display and hidden fields
        console.log(`Frontend-only save: ${newValue}`);
        
        // Update display immediately
        document.getElementById("unpaid-invoices-points-display").textContent = newValue;
        document.getElementById("unpaid-invoices-hidden").value = newValue;
        
        // Reset UI state
        document.getElementById("unpaid-invoices-points-display").style.display = "inline";
        document.getElementById("edit-unpaid-invoices-btn").style.display = "inline-block";
        document.getElementById("unpaid-invoices-input").style.display = "none";
        document.getElementById("save-unpaid-invoices-btn").style.display = "none";
        
        console.log('Frontend-only save completed - no backend contamination');
}

        // Scoring Presets Accordion Toggle Function
                // Preset Management Functions
        function toggleCreateForm() {
            const form = document.getElementById('create-form');
            const btn = document.getElementById('create-preset-btn');
            
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'inline-block';
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
        }

        function cancelCreateForm() {
            const form = document.getElementById('create-form');
            const btn = document.getElementById('create-preset-btn');
            
            form.style.display = 'none';
            btn.disabled = false;
            btn.style.opacity = '1';
            document.getElementById('preset-name').value = '';
            document.getElementById('preset-description').value = '';
        }


        function saveNewPreset() {
            const name = document.getElementById('preset-name').value;
            const description = document.getElementById('preset-description').value;
            
            if (!name.trim()) {
                alert('Please enter a preset name.');
                return;
            }
            
            // CONFIRMATION POPUP - New addition
            const confirmMessage = `Confirm creation of the '${name.trim()}' preset?`;
            if (!confirm(confirmMessage)) {
                // User clicked Cancel - stay in create mode
                console.log('Preset creation cancelled by user');
                return;
            }
            
            // User clicked OK - proceed with creation
            console.log('Creating preset with backend integration:', name, description);
            
            // Show loading state
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            // Prepare form data
            const formData = new FormData();
            formData.append('action', 'create_preset');
            formData.append('preset_name', name);
            formData.append('preset_description', description);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Capture current slider values from DOM
            console.log('Capturing current slider values...');
            const sliderFields = [
                'future_appointments_weight',
                'age_demographics_weight', 
                'yearly_spend_weight',
                'consecutive_attendance_weight',
                'cancellations_weight',
                'dna_weight',
                'unpaid_invoices_weight',
                'open_dna_invoice_weight'
            ];
            
            sliderFields.forEach(fieldName => {
                const slider = document.querySelector(`input[name="${fieldName}"]`);
                if (slider) {
                    formData.append(fieldName, slider.value);
                    console.log(`Added ${fieldName}: ${slider.value}`);
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.warn(`Slider not found: ${fieldName}`);
                }
            });
            
            // Capture current points values from hidden fields
            console.log('Capturing current points values...');
            const pointsFields = [
                {name: 'points_per_consecutive_attendance', hiddenId: 'consecutive-hidden'},
                {name: 'points_per_cancellation', hiddenId: 'cancellations-hidden'},
                {name: 'points_per_dna', hiddenId: 'dna-hidden'},
                {name: 'points_per_unpaid_invoice', hiddenId: 'unpaid-invoices-hidden'}
            ];
            
                        console.log("üîç DEBUG: pointsFields array:", pointsFields);
            pointsFields.forEach(field => {
                const hiddenInput = document.getElementById(field.hiddenId);
                if (hiddenInput) {
                    formData.append(field.name, hiddenInput.value);
                    console.log(`Added ${field.name}: ${hiddenInput.value}`);
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.warn(`Hidden field not found: ${field.hiddenId}`);
                }
            });
            
  
        
        // SIMPLIFIED BRACKET CAPTURE - Using hidden fields like sliders
        console.log('Using simplified bracket capture from hidden fields');
        
        // Sync current display with hidden fields first
        syncAllBracketData();
        
        // Read bracket data from hidden fields (like sliders)
        const ageBracketsData = document.getElementById('age-brackets-data').value;
        const spendBracketsData = document.getElementById('spend-brackets-data').value;
        
        if (ageBracketsData) {
            formData.append('age_brackets_data', ageBracketsData);
            console.log('Added age brackets data from hidden field');
        }
        
        if (spendBracketsData) {
            formData.append('spend_brackets_data', spendBracketsData);
            console.log('Added spend brackets data from hidden field');
        }
        
        // FALLBACK: Complex bracket capture (existing logic)          // Capture current age brackets from screen display (based on DOM investigation)
            console.log('Capturing current age brackets from screen...');
            const ageBrackets = [];
            const ageBracketElements = document.querySelectorAll('#age-brackets-content > div > div');
            
            ageBracketElements.forEach((element, index) => {
                // Based on investigation: nested div structure with range and percentage
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                console.log('Skipping bracket element', index, '- invalid structure');
                return;
                }

                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                console.log('Skipping bracket element', index, '- invalid bracket content');
                return;
                }

                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    let minAge, maxAge;
                    // Handle "65+" format and "18-25" format (from investigation)
                    if (rangeText.includes('+')) {
                        minAge = parseInt(rangeText.replace('+', ''));
                        maxAge = 999;
                    } else if (rangeText.includes('-')) {
                        const parts = rangeText.split('-');
                        minAge = parseInt(parts[0]);
                        maxAge = parseInt(parts[1]);
                    }
                    
                    if (!isNaN(minAge) && !isNaN(maxAge) && !isNaN(percentage)) {
                        ageBrackets.push({
                            min_age: minAge,
                            max_age: maxAge,
                            percentage: percentage,
                            order: index
                        });
                        console.log(`Added age bracket: ${minAge}-${maxAge}, ${percentage}%`);
                    }
                }
            });
            
            if (ageBrackets.length > 0) {
                formData.append('screen_age_brackets', JSON.stringify(ageBrackets));
                console.log(`Captured ${ageBrackets.length} age brackets from screen`);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.log('No age brackets found on screen');
            }
            
            // Capture current spend brackets from screen display (based on DOM investigation)
            console.log('Capturing current spend brackets from screen...');
            const spendBrackets = [];
            const spendBracketElements = document.querySelectorAll('#spend-brackets-content > div > div');
            
            spendBracketElements.forEach((element, index) => {
                // Same structure as age brackets but with spend amounts
                // CRITICAL FIX: Add safety checks before accessing children
                if (!element || !element.children || !element.children[0]) {
                    console.log('Skipping spend bracket element', index, '- invalid structure');
                    return;
                }
                
                const bracketContent = element.children[0];
                if (!bracketContent || !bracketContent.children || bracketContent.children.length < 2) {
                    console.log('Skipping spend bracket element', index, '- invalid bracket content');
                    return;
                }
                
                const rangeDiv = bracketContent.children[0];
                const percentDiv = bracketContent.children[1];
                
                if (rangeDiv && percentDiv) {
                    const rangeText = rangeDiv.textContent.trim();
                    const percentText = percentDiv.textContent.trim();
                    const percentage = parseInt(percentText.replace('%', ''));
                    
                    let minSpend, maxSpend;
                    // Handle spend format with $ symbols
                    if (rangeText.includes('+')) {
                        minSpend = parseFloat(rangeText.replace('+', '').replace('$', ''));
                        maxSpend = 999999.99;
                    } else if (rangeText.includes('-')) {
                        const parts = rangeText.split('-');
                        minSpend = parseFloat(parts[0].replace('$', ''));
                        maxSpend = parseFloat(parts[1].replace('$', ''));
                    }
                    
                    if (!isNaN(minSpend) && !isNaN(maxSpend) && !isNaN(percentage)) {
                        spendBrackets.push({
                            min_spend: minSpend,
                            max_spend: maxSpend,
                            percentage: percentage,
                            order: index
                        });
                        console.log(`Added spend bracket: $${minSpend}-$${maxSpend}, ${percentage}%`);
                    }
                }
            });
            
            if (spendBrackets.length > 0) {
                formData.append('screen_spend_brackets', JSON.stringify(spendBrackets));
                console.log(`Captured ${spendBrackets.length} spend brackets from screen`);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.log('No spend brackets found on screen');
            }
            
            // Call backend (basic structure)
            fetch('/patients/dashboard/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Backend response:', data);
                
                if (data.success) {
                
                // Update accordion header - saveNewPreset (NON-BOLD - created but not applied)
                const accordionTitle = document.querySelector('.accordion-title');
                if (accordionTitle && data.preset && data.preset.name) {
                    accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: ${data.preset.name}`;
                    console.log('Accordion header updated to show new preset:', data.preset.name);
                // Show success message
                const saveMessage = document.getElementById("save-message");
                if (saveMessage) {
                    saveMessage.textContent = "‚úÖ Success";
                    saveMessage.style.display = "block";
                    setTimeout(() => {
                        saveMessage.style.display = "none";
                    }, 3000);
                }
                
                }
                    // Temporary: Keep existing UI updates for now
                    const header = document.querySelector('.accordion-title');
                    header.innerHTML = "‚öôÔ∏è <strong>Scoring Presets</strong> - Current preset: " + name;
                    
                    const dropdown = document.getElementById('preset-dropdown');
                    const option = document.createElement('option');
                    option.value = data.preset_id || name.toLowerCase().replace(/\s+/g, '_');
                    option.text = name;
                    dropdown.add(option);
                    dropdown.value = option.value;
                    
                    // Show success message next to Update Weights button
                    const saveMessage = document.getElementById('save-message');
                    if (saveMessage) {
                        saveMessage.style.display = 'inline';
                        setTimeout(() => {
                            saveMessage.style.display = 'none';
                        }, 3000); // Hide after 3 seconds
                    }
                    cancelCreateForm();
                        
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                    console.error('Error creating preset:', data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('AJAX error:', error);
                console.error('Error creating preset:', error.message);
            })
            .finally(() => {
                // Restore button state
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
        }


    
    // Scoring Presets Toggle Function
    function updateCurrentPreset() {
    // Get the current preset name from the header
    const presetNameElement = document.querySelector('.accordion-title strong:last-of-type');
    const updatePresetName = presetNameElement ? presetNameElement.textContent.trim() : 'Unknown';
    
    // Show confirmation popup
    if (confirm(`Do you wish to update the ${updatePresetName} preset?`)) {
        // Collect all current screen state data
        const formData = collectCurrentScreenState();
        
        // Add the update_preset action
        formData.append('action', 'update_preset');
        
        // Show loading state
        const updateBtn = document.getElementById('update-preset-btn');
        const originalText = updateBtn.textContent;
        updateBtn.textContent = 'Updating...';
        updateBtn.disabled = true;
        
        // Send AJAX request to backend
        fetch('/patients/dashboard/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            // Restore button state
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
            
            if (data.success) {
                // SUCCESS: Get current preset ID and reapply the updated preset
                console.log('‚úÖ Preset updated successfully:', updatePresetName);
                
                // Get the current applied preset ID from dropdown
                const dropdown = document.getElementById('preset-dropdown');
                const currentPresetId = dropdown ? dropdown.value : null;
                
                if (currentPresetId && updatePresetName) {
                    // Reapply the updated preset to refresh all UI
                    console.log('üîÑ Reapplying updated preset:', currentPresetId, updatePresetName);
                    applyPresetById(currentPresetId, updatePresetName);
                } else {
                    console.error('‚ùå Could not get preset ID for reapplication:', {currentPresetId, updatePresetName});
                    // Fallback: manual header update
                    const accordionTitle = document.querySelector('.accordion-title');
                    if (accordionTitle) {
                        accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>${updatePresetName}</strong>`;
                    }
                }
                
                // Show success message
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = "‚úÖ Success";
                    saveMessage.style.display = 'block';
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                    }, 3000);
                }
            } else {
                // Show error in existing message element
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = '‚ùå Error updating preset: ' + (data.error || 'Unknown error');
                    saveMessage.style.color = '#dc3545';
                    saveMessage.style.display = 'block';
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                        saveMessage.style.color = '#28a745'; // Reset to green
                    }, 5000);
                }
            }
        })
        .catch(error => {
            // Restore button state
            updateBtn.textContent = originalText;
            updateBtn.disabled = false;
            
            console.error('Error updating preset:', error);
            // Show error in existing message element
                const saveMessage = document.getElementById('save-message');
                if (saveMessage) {
                    saveMessage.textContent = '‚ùå Error updating preset: ' + error.message;
                    saveMessage.style.color = '#dc3545';
                    saveMessage.style.display = 'block';
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                        saveMessage.style.color = '#28a745'; // Reset to green
                    }, 5000);
                }
        });
    }
}

function collectCurrentScreenState() {
    // Sync all bracket data before collection
    syncAllBracketData();
    
    const formData = new FormData();
    
    // Collect all slider values
    const sliders = ['future_appointments_weight', 'age_demographics_weight', 'yearly_spend_weight', 
                    'consecutive_attendance_weight', 'cancellations_weight', 'dna_weight', 
                    'unpaid_invoices_weight', 'open_dna_invoice_weight'];
    
    sliders.forEach(sliderId => {
        const slider = document.querySelector(`input[name="${sliderId}"]`);
        if (slider) {
            formData.append(sliderId, slider.value);
        }
    });
    
    // Collect all points values
    const pointsFields = ['points_per_consecutive_attendance', 'points_per_cancellation', 
                         'points_per_dna', 'points_per_unpaid_invoice'];
    
    pointsFields.forEach(fieldId => {
        const inputField = document.querySelector(`input[name='${fieldId}']`);
        if (inputField) {
            formData.append(fieldId, inputField.value);
        }
    });
    
    // Collect age brackets from current display
    const ageBrackets = [];
    const ageBracketElements = document.querySelectorAll('#age-brackets-content > div > div');
    ageBracketElements.forEach((element, index) => {
        const rangeText = element.children[0]?.children[0]?.textContent?.trim();
        const percentageText = element.children[0]?.children[1]?.textContent?.trim();
        
        if (rangeText && percentageText) {
            const percentage = parseInt(percentageText.replace('%', ''));
            let minAge, maxAge;
            
            if (rangeText.includes('+')) {
                minAge = parseInt(rangeText.replace('+', ''));
                maxAge = 999;
            } else if (rangeText.includes('-')) {
                const parts = rangeText.split('-');
                minAge = parseInt(parts[0]);
                // Clean parsing - no corruption fix needed with proper DOM navigation
                maxAge = parseInt(parts[1]);
            }
            
            if (!isNaN(minAge) && !isNaN(maxAge) && !isNaN(percentage)) {
                ageBrackets.push({
                    min_age: minAge,
                    max_age: maxAge,
                    percentage: percentage,
                    order: index
                });
            }
        }
    });
    
    if (ageBrackets.length > 0) {
        formData.append('age_brackets_data', JSON.stringify(ageBrackets));
    }
    
    // Collect spend brackets from current display
    const spendBrackets = [];
    const spendBracketElements = document.querySelectorAll('#spend-brackets-content > div > div');
    spendBracketElements.forEach((element, index) => {
        const rangeText = element.children[0]?.children[0]?.textContent?.trim();
        const percentageText = element.children[0]?.children[1]?.textContent?.trim();
        
        if (rangeText && percentageText) {
            const percentage = parseInt(percentageText.replace('%', ''));
            let minSpend, maxSpend;
            
            if (rangeText.includes('+')) {
                minSpend = parseFloat(rangeText.replace('+', ''));
                maxSpend = 999999.99;
            } else if (rangeText.includes('-')) {
                const parts = rangeText.split('-');
                minSpend = parseFloat(parts[0]);
                maxSpend = parseFloat(parts[1]);
            }
            
            if (!isNaN(minSpend) && !isNaN(maxSpend) && !isNaN(percentage)) {
                spendBrackets.push({
                    min_spend: minSpend,
                    max_spend: maxSpend,
                    percentage: percentage,
                    order: index
                });
            }
        }
    });
    
    if (spendBrackets.length > 0) {
        formData.append('spend_brackets_data', JSON.stringify(spendBrackets));
    }
    
    return formData;
}

function toggleScoringPresets() {
        console.log('Scoring Presets clicked');
        const content = document.getElementById('scoring-presets-content');
        const arrow = document.getElementById('presets-arrow');
        
        if (content) {
            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                content.style.maxHeight = '500px';
                if (arrow) arrow.textContent = '‚ñ≤';
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                content.style.maxHeight = '0px';
                if (arrow) arrow.textContent = '‚ñº';
            }
                
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
            console.error('scoring-presets-content not found');
        }
    }
    
    // Placeholder functions for preset management
    
    function toggleCreateForm() {
        console.log('Toggle create form clicked');
        const form = document.getElementById('create-form');
        if (form) {
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    // Removed duplicate saveNewPreset stub - using main implementation
    
    function cancelCreateForm() {
        console.log('Cancel create form clicked');
        const form = document.getElementById('create-form');
        if (form) {
            form.style.display = 'none';
        }
    }
        
        // STEP 3: Minimal Preset Loading Function - Safe Implementation
        function loadPresets() {
            console.log('üîÑ Loading presets into dropdown...');
            
            fetch('/patients/presets/get/')
                .then(response => {
                    console.log('üì° Response received:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Preset data:', data);
                    
                    const presetSelect = document.getElementById('preset-dropdown');
                    if (presetSelect && data.presets) {
                        console.log('‚úÖ Found dropdown element and preset data');
                        
                        // Clear existing options except first
                        const firstOption = presetSelect.firstElementChild;
                        presetSelect.innerHTML = '';
                        if (firstOption) {
                            presetSelect.appendChild(firstOption);
                        }
                        
                        // Add preset options
                        data.presets.forEach(preset => {
                            const option = document.createElement('option');
                            option.value = preset.id;
                            option.textContent = preset.name;
                            presetSelect.appendChild(option);
                            console.log('‚ûï Added preset:', preset.name);
                        });
                        
                        console.log('üéâ Successfully loaded ' + data.presets.length + ' presets');
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.warn('‚ö†Ô∏è Dropdown element or preset data not found');
                        console.log('Available elements:', document.querySelectorAll('[id*="preset"]'));
                    }
                })
                .catch(error => {
                    console.error('üö® Error loading presets:', error);
                });
        }
        
        // Auto-load presets when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded, auto-loading presets...');
            loadPresets();
    
    // Restore applied preset header after page refresh
    // DISABLED AUTOLOAD: const savedPresetName = localStorage.getItem('appliedPresetName');
    // DISABLED AUTOLOAD: if (savedPresetName) {
    // DISABLED AUTOLOAD: console.log('üîÑ Restoring applied preset header:', savedPresetName);
    // DISABLED AUTOLOAD: updatePresetHeader(savedPresetName);
    // DISABLED AUTOLOAD: }
        });

        // ===== DISPLAY BUTTON FUNCTIONALITY - SAFE ADDITION =====
        // Added: July 23, 2025 - No existing code modified
        
        function displayPreset() {
            console.log('Display button clicked - Safe implementation');
            
            const dropdown = document.getElementById('preset-dropdown');
            if (dropdown === null) {
                console.error('Preset dropdown not found');
                alert('Error: Preset dropdown not found');
                return;
            }
            
            const selectedValue = dropdown.value;
    
    // Set global variables for handleFormSubmit to use
    window.applyPresetInProgress = true;
    window.selectedPresetValue = selectedValue;
            if (selectedValue === '' || selectedValue === null) {
                console.log('No preset selected');
                alert('Please select a preset first');
                return;
            }
            
            console.log('Fetching preset data for ID:', selectedValue);
            
            fetch('/patients/presets/get/' + selectedValue + '/')
                .then(function(response) {
                    console.log('Response status:', response.status);
                    if (response.ok === false) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('Preset data received:', data);
                    if (data.success === true && data.preset) {
            
            // Update accordion header - displayPreset (NON-BOLD - Display-only)
            const accordionTitle = document.querySelector('.accordion-title');
            const dropdown = document.getElementById('preset-dropdown');
            if (accordionTitle && dropdown) {
                const presetName = dropdown.options[dropdown.selectedIndex].text;
                accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: ${presetName}`;
            }
            
                        loadPresetIntoSliders(data.preset);

            // CRITICAL FIX: Update bracket displays on screen
            console.log('Updating bracket displays from preset data...');
            
            // Update age brackets display
            if (data.preset && data.preset.age_brackets) {
                updateAgeBracketsDisplay(data.preset.age_brackets);
                console.log('Updated age brackets display with', data.preset.age_brackets.length, 'brackets');
            }
            
            // Update spend brackets display
            if (data.preset && data.preset.spend_brackets) {
                updateSpendBracketsDisplay(data.preset.spend_brackets);
                console.log('Updated spend brackets display with', data.preset.spend_brackets.length, 'brackets');
            }
            
            console.log('All preset elements updated on screen - sliders, points, and brackets');

            // Show success message
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.textContent = "‚úÖ Success";
                saveMessage.style.display = "block";
                setTimeout(() => {
                    saveMessage.style.display = "none";
                }, 3000);
            }
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.error('Invalid preset data:', data);
                        alert('Error: Invalid preset data received');
                    }
                })
                .catch(function(error) {
                    console.error('Error fetching preset:', error);
                    alert('Error fetching preset data: ' + error.message);
                });
        }
        

    // CRITICAL FIX: Missing bracket update functions for Apply/Display buttons
    function updateAgeBracketsDisplay(brackets) {
        console.log('updateAgeBracketsDisplay called with', brackets.length, 'brackets');
        
        // Find the age brackets display container
        const ageBracketsContainer = document.getElementById('age-brackets-list');
        if (!ageBracketsContainer) {
            console.error('Age brackets container not found');
            return;
        }
        
        // CRITICAL FIX: Preserve ADD button, only remove bracket divs
        const addButton = ageBracketsContainer.querySelector('button[onclick="addNewAgeBracket()"]');
        const bracketDivs = ageBracketsContainer.querySelectorAll('div[style*="flex-direction: column"]');
        bracketDivs.forEach(div => div.remove());
        
        // Add each bracket with CORRECT original HTML structure
        brackets.forEach((bracket, index) => {
            const outerDiv = document.createElement('div');
            outerDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
            
            const bracketContent = document.createElement('div');
            bracketContent.style.cssText = 'display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;';
            
            const rangeDiv = document.createElement('div');
            rangeDiv.style.cssText = 'padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;';
            rangeDiv.textContent = bracket.min_age + '-' + bracket.max_age;
            
            const percentDiv = document.createElement('div');
            percentDiv.style.cssText = 'padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;';
            percentDiv.textContent = bracket.percentage + '%';
            
            bracketContent.appendChild(rangeDiv);
            bracketContent.appendChild(percentDiv);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 4px; margin-top: 2px;';
            
            const deleteButton = document.createElement('button');
            deleteButton.setAttribute('onclick', `deleteAgeBracket(${bracket.id || index})`);
            deleteButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;';
            deleteButton.textContent = 'Delete';
            
            buttonContainer.appendChild(deleteButton);
            outerDiv.appendChild(bracketContent);
            outerDiv.appendChild(buttonContainer);
            
            // Insert before ADD button to maintain order
            if (addButton) {
                ageBracketsContainer.insertBefore(outerDiv, addButton);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                ageBracketsContainer.appendChild(outerDiv);
            }
        });
        
        console.log('Age brackets display updated with preserved structure');
    }

    function updateSpendBracketsDisplay(brackets) {
        console.log('updateSpendBracketsDisplay called with', brackets.length, 'brackets');
        
        // Find the spend brackets display container
        const spendBracketsContainer = document.getElementById('spend-brackets-list');
        if (!spendBracketsContainer) {
            console.error('Spend brackets container not found');
            return;
        }
        
        // CRITICAL FIX: Preserve ADD button, only remove bracket divs
        const addButton = spendBracketsContainer.querySelector('button[onclick="addNewSpendBracket()"]');
        const bracketDivs = spendBracketsContainer.querySelectorAll('div[style*="flex-direction: column"]');
        bracketDivs.forEach(div => div.remove());
        
        // Add each bracket with CORRECT original HTML structure and NO $ signs
        brackets.forEach((bracket, index) => {
            const outerDiv = document.createElement('div');
            outerDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
            
            const bracketContent = document.createElement('div');
            bracketContent.style.cssText = 'display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;';
            
            const rangeDiv = document.createElement('div');
            rangeDiv.style.cssText = 'padding: 4px 12px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;';
            // CRITICAL FIX: NO $ signs - clean numbers only
            rangeDiv.textContent = bracket.max_spend >= 999999.99 ? bracket.min_spend + '+' : bracket.min_spend + '-' + bracket.max_spend;
            
            const percentDiv = document.createElement('div');
            percentDiv.style.cssText = 'padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;';
            percentDiv.textContent = bracket.percentage + '%';
            
            bracketContent.appendChild(rangeDiv);
            bracketContent.appendChild(percentDiv);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 4px; margin-top: 2px;';
            
            const deleteButton = document.createElement('button');
            deleteButton.setAttribute('onclick', `deleteSpendBracket(${bracket.id || index})`);
            deleteButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;';
            deleteButton.textContent = 'Delete';
            
            buttonContainer.appendChild(deleteButton);
            outerDiv.appendChild(bracketContent);
            outerDiv.appendChild(buttonContainer);
            
            // Insert before ADD button to maintain order
            if (addButton) {
                spendBracketsContainer.insertBefore(outerDiv, addButton);
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                spendBracketsContainer.appendChild(outerDiv);
            }
        });
        
        console.log('Spend brackets display updated with preserved structure and no $ signs');
    }

    function loadPresetIntoSliders(presetData) {
        console.log('Loading preset data into sliders:', presetData);
        
        // Load slider values (existing functionality)
        const sliderMappings = [
            { sliderName: 'future_appointments_weight', valueName: 'future_appointments_weight' },
            { sliderName: 'age_demographics_weight', valueName: 'age_demographics_weight' },
            { sliderName: 'yearly_spend_weight', valueName: 'yearly_spend_weight' },
            { sliderName: 'consecutive_attendance_weight', valueName: 'consecutive_attendance_weight' },
            { sliderName: 'cancellations_weight', valueName: 'cancellations_weight' },
            { sliderName: 'dna_weight', valueName: 'dna_weight' },
            { sliderName: 'unpaid_invoices_weight', valueName: 'unpaid_invoices_weight' },
            { sliderName: 'open_dna_invoice_weight', valueName: 'open_dna_invoice_weight' }
        ];
        
        // Update sliders (existing logic)
        sliderMappings.forEach(mapping => {
            const slider = document.querySelector(`input[name="${mapping.sliderName}"]`);
            // CRITICAL FIX: Correct element selection with debugging
            let valueDisplayId;
            if (mapping.valueName === 'future_appointments_weight' || mapping.valueName === 'age_demographics_weight' || mapping.valueName === 'yearly_spend_weight' || mapping.valueName === 'consecutive_attendance_weight') {
                // These use clean pattern: future_appointments_value, age_demographics_value, etc.
                valueDisplayId = `${mapping.valueName.replace('_weight', '')}_value`;
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                // These use weight pattern: cancellations_weight_value, dna_weight_value, etc.
                valueDisplayId = `${mapping.valueName}_value`;
            }
            const valueDisplay = document.getElementById(valueDisplayId);
            
            // Debug logging
            console.log(`Slider: ${mapping.sliderName}, Looking for display: ${valueDisplayId}, Found: ${valueDisplay !== null}`);
            if (slider) console.log(`Slider found, setting value to: ${presetData[mapping.valueName]}`);
            if (valueDisplay) console.log(`Display found, setting text to: ${presetData[mapping.valueName]}`);
            if (!slider) console.error(`Slider not found: input[name="${mapping.sliderName}"]`);
            if (!valueDisplay) console.error(`Display not found: ${valueDisplayId}`);
            
            if (slider && presetData[mapping.valueName] !== undefined) {
                slider.value = presetData[mapping.valueName];
                if (valueDisplay) {
                    valueDisplay.textContent = presetData[mapping.valueName];
                }
            }
        });
        
        // CRITICAL FIX: Load points values from preset data (prevent contamination)
        console.log('Loading points values from preset data to prevent contamination...');
        
        const pointsMappings = [
            { 
                field: 'points_per_consecutive_attendance',
                displayId: 'consecutive-points-display',
                hiddenId: 'consecutive-hidden',
                inputId: 'consecutive-input'
            },
            { 
                field: 'points_per_cancellation',
                displayId: 'cancellations-points-display',
                hiddenId: 'cancellations-hidden',
                inputId: 'cancellations-input'
            },
            { 
                field: 'points_per_dna',
                displayId: 'dna-points-display',
                hiddenId: 'dna-hidden',
                inputId: 'dna-input'
            },
            { 
                field: 'points_per_unpaid_invoice',
                displayId: 'unpaid-invoices-points-display',
                hiddenId: 'unpaid-invoices-hidden',
                inputId: 'unpaid-invoices-input'
            }
        ];
        
        // Update points displays and hidden fields from preset data
        pointsMappings.forEach(mapping => {
            if (presetData[mapping.field] !== undefined) {
                const displayElement = document.getElementById(mapping.displayId);
                const hiddenElement = document.getElementById(mapping.hiddenId);
                const inputElement = document.getElementById(mapping.inputId);
                
                const pointsValue = presetData[mapping.field];
                
                // Update display box
                if (displayElement) {
                    displayElement.textContent = pointsValue;
                }
                
                // Update hidden field (for form submission)
                if (hiddenElement) {
                    hiddenElement.value = pointsValue;
                }
                
                // Update input field (for editing)
                if (inputElement) {
                    inputElement.value = pointsValue;
                }
                
                console.log(`Updated ${mapping.field}: ${pointsValue}`);
            }
        });
        
        console.log('Points contamination fix applied - all points boxes now preset-specific');
    }
        
        // ===== END DISPLAY BUTTON FUNCTIONALITY =====
    
// Apply Button - Hybrid Implementation (Form Submission + AJAX Bracket Operations)
    function applyPreset() {
        console.log("üéØ applyPreset() called - using fixed implementation");
        
        const selectedPresetId = getSelectedPresetId();
        if (!selectedPresetId) {
            alert('Please select a preset to apply.');
            return;
        }
        
        console.log("üîç Applying preset ID:", selectedPresetId);
        
        // Use the working applyPresetById logic
        fetch('/patients/dashboard/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `action=apply_preset&preset_id=${selectedPresetId}`
        })
        .then(response => response.json())
        .then(data => {
            console.log("üîç DEBUG: Complete AJAX response data:", data);
            
            if (data.success) {
                console.log("‚úÖ Preset applied successfully via AJAX:", data.message);
                
                // Update header
                updatePresetHeader(data.preset?.name || 'Applied Preset');
                
                // Update dropdown to show applied preset
                const dropdown = document.getElementById('preset-dropdown');
                if (dropdown) {
                    dropdown.value = selectedPresetId;
                }
                
                // Apply all preset values to UI
                if (data.preset) {
                    console.log("üîç DEBUG: data.preset exists?", !!data.preset);
                    
                    // Update all sliders with preset values
                    const sliderFields = [
                        'future_appointments_weight', 'age_demographics_weight', 'yearly_spend_weight',
                        'consecutive_attendance_weight', 'cancellations_weight', 'dna_weight',
                        'unpaid_invoices_weight', 'open_dna_invoice_weight'
                    ];
                    
                    sliderFields.forEach(field => {
                        const slider = document.getElementById(field);
                        const display = document.getElementById(field + '_display');
                        
                        if (slider && data.preset[field] !== undefined) {
                            slider.value = data.preset[field];
                            if (display) {
                                display.textContent = data.preset[field];
                            }
                            console.log(`‚úÖ Updated slider ${field}:`, data.preset[field]);
                        }
                    });
                    
                    console.log("üîç DEBUG: About to process points fields. data.preset exists:", !!data.preset);
                    // Update points fields
                    const pointsFields = [
                        'points_per_consecutive_attendance', 'points_per_cancellation',
                        'points_per_dna', 'points_per_unpaid_invoice'
                    ];
                    
                    pointsFields.forEach(field => {
                        const display = document.getElementById(field.replace('points_per_', '') + '-points-display');
                        const hidden = document.getElementById(field.replace('points_per_', '') + '-hidden');
                        
                        if (display && data.preset[field] !== undefined) {
                            display.textContent = data.preset[field];
                            if (hidden) {
                                hidden.value = data.preset[field];
                            }
                            console.log(`‚úÖ Updated points ${field}:`, data.preset[field]);
                        }
                    });
                    
                    // Update brackets if included in response
                    if (data.age_brackets) {
                        updateAgeBracketsDisplay(data.age_brackets);
                        console.log("‚úÖ Updated age brackets");
                    }
                    
                    if (data.spend_brackets) {
                        updateSpendBracketsDisplay(data.spend_brackets);
                        console.log("‚úÖ Updated spend brackets");
                    }
                    
                    console.log("‚úÖ All preset values applied to UI");
                } else {
                    console.log("‚ùå No preset data in response");
                }
                
                // Show success message
                showInlineSuccessMessage('preset-actions', 'Preset applied successfully');
                
            } else {
                console.error("‚ùå Apply preset failed:", data.message);
                alert('Failed to apply preset: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('‚ùå Apply preset error:', error);
            alert('Error applying preset. Please try again.');
        });
    }
    function submitFormWithPresetData(selectedValue, cleanPresetName, originalText) {
        console.log('Submitting form with loaded preset data...');
        
        // Step 2: Submit the main form to save all 8 slider values
    const form = document.querySelector("form");
    if (!form) {
        console.error("Scoring form not found");
        alert("Error: Could not find scoring form");
        return;
    }
    
    // Show loading state
    const applyButton = document.getElementById("apply-preset-btn");
    originalText = applyButton.innerHTML;
    applyButton.innerHTML = "Applying...";
    applyButton.disabled = true;
    
    // Submit form using existing handleFormSubmit logic
    
    // Sync current screen data to hidden fields before submission
    console.log("üîÑ Syncing bracket data before form submission");
    updateAgeBracketsData();
    updateSpendBracketsData();
    console.log("‚úÖ Bracket data synced successfully");

    const formData = new FormData(form);
    
    // DEBUG: Show what Apply button sends to Django
    console.log("üîç APPLY BUTTON DEBUG - FormData contents:");
    console.log(Array.from(formData.entries()));
    console.log("üîç Does Apply button send action parameter?", formData.get('action'));
    
    fetch("/patients/dashboard/", {
        method: "POST",
        body: formData,
        headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Form submission failed");
        }
        return response.json();
    })
    .then(data => {
        console.log("Form submitted successfully");
        
        // Step 2: Clear and bulk insert age brackets
        return clearAndInsertBrackets("age", selectedValue);
    })
    .then(() => {
        console.log("Age brackets updated successfully");
        
        // Step 3: Clear and bulk insert spend brackets  
        return clearAndInsertBrackets("spend", selectedValue);
    })
    .then(() => {
        console.log("Spend brackets updated successfully");
        
        // Step 4: Update UI to reflect changes
        updatePresetHeader(cleanPresetName);
            

            console.log("Saved applied preset to localStorage:", cleanPresetName);
        

        console.log('Saved applied preset to localStorage:', cleanPresetName);
        
        // Show success message
        alert("Preset applied successfully: " + cleanPresetName);
        
        // Restore button state
        applyButton.innerHTML = originalText;
        applyButton.disabled = false;
        
        console.log("Apply preset completed successfully");
        
        // Reset saving flag to unblock bracket buttons
        window.savingInProgress = false;
    })
    .catch(error => {
        console.error("Apply preset error:", error);
        alert("Error applying preset: " + error.message);
        
        // Restore button state on error
        applyButton.innerHTML = originalText;
        applyButton.disabled = false;
    });
}

// Helper function to clear and insert brackets
function clearAndInsertBrackets(bracketType, presetValue) {
    return new Promise((resolve, reject) => {
        // Step 1: Clear existing brackets
        fetch("/patients/dashboard/", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                "Content-Type": "application/x-www-form-urlencoded",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: "action=clear_" + bracketType + "_brackets"
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || "Clear operation failed");
            }
            console.log("Cleared " + bracketType + " brackets:", data.deleted_count);
            
            // Step 2: Get bracket data for selected preset
            const bracketData = getBracketDataForPreset(bracketType, presetValue);
            
            // Step 3: Bulk insert new brackets
            return fetch("/patients/dashboard/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: "action=insert_" + bracketType + "_brackets&brackets_data=" + encodeURIComponent(JSON.stringify(bracketData))
            });
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || "Bulk insert failed");
            }
            console.log("Inserted " + bracketType + " brackets:", data.inserted_count);
            resolve(data);
        })
        .catch(error => {
            console.error("Error updating " + bracketType + " brackets:", error);
            reject(error);
        });
    });
}

// Helper function to get bracket data for preset (placeholder implementation)
function getBracketDataForPreset(bracketType, presetValue) {
    // This function should load bracket data from the database for the selected preset
    // For now, we'll use a synchronous approach with preset-specific data
    
    console.log('Loading bracket data for preset:', presetValue, 'type:', bracketType);
    
    // TODO: Replace with actual AJAX call to load brackets from database
    // For now, return different data based on preset ID
    
    if (presetValue == 1) { // Factory Settings
        if (bracketType === "age") {
            return [
                { min_age: 18, max_age: 25, percentage: 5, order: 1 },
                { min_age: 26, max_age: 35, percentage: 10, order: 2 },
                { min_age: 36, max_age: 45, percentage: 15, order: 3 },
                { min_age: 46, max_age: 55, percentage: 20, order: 4 },
                { min_age: 56, max_age: 65, percentage: 15, order: 5 },
                { min_age: 66, max_age: 100, percentage: 25, order: 6 }
            ];
        } else if (bracketType === "spend") {
            return []; // Factory Settings has no spend brackets
        }
    } else {
        // For other presets, return empty brackets for now
        // TODO: Load actual bracket data from database
        console.log('No bracket data defined for preset', presetValue);
        return [];
    }
    
    return [];
}

// Helper function to update preset header
function updatePresetHeader(presetName) {
    const header = document.querySelector(".accordion-title");
    if (header) {
        header.innerHTML = "‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>" + presetName + "</strong>";
        
        // Update the center buttons section
        const centerButtons = header.parentElement.querySelector('.center-buttons');
        if (centerButtons) {
            centerButtons.innerHTML = '<button id=\"update-preset-btn\" onclick=\"updateCurrentPreset()\" style=\"background: #007bff; color: white; border: none; padding: 5px 12px; border-radius: 3px; font-size: 0.85rem; cursor: pointer;\">Update</button><span class=\"info-icon\" title=\"This button updates the existing, applied preset.\">‚ìò</span>';
        }
    }
}

// Helper function to apply preset by ID (used by delete preset fallback)
function applyPresetById(presetId, presetName) {
    console.log('applyPresetById called with:', presetId, presetName);
    
    // Update header to show the preset being applied
    const accordionTitle = document.querySelector('.accordion-title');
    if (accordionTitle) {
        accordionTitle.innerHTML = `‚öôÔ∏è <strong>Scoring Presets</strong> - Currently: <strong>${presetName}</strong>`;
        console.log('Header updated to show applied preset:', presetName);
    }
    
    // Set the dropdown to the specified preset
    const dropdown = document.getElementById('preset-dropdown');
    if (dropdown) {
        for (let i = 0; i < dropdown.options.length; i++) {
            if (dropdown.options[i].value === presetId.toString()) {
                dropdown.selectedIndex = i;
                console.log('Dropdown set to preset:', presetName);
                break;
            }
        }
    }
    
    // Send AJAX request to apply the preset without form submission
    fetch('/patients/dashboard/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `action=apply_preset&preset_id=${presetId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const saveMessage = document.getElementById("save-message");
            if (saveMessage) {
                saveMessage.textContent = "‚úÖ Success";
                saveMessage.style.display = "block";
                setTimeout(() => {
                    saveMessage.style.display = "none";
                }, 3000);
            }

            console.log('Preset applied successfully via AJAX: Preset ID', presetId);
            
            // DEBUG: Log the complete AJAX response data
            console.log('üîç DEBUG: Complete AJAX response data:', JSON.stringify(data, null, 2));
            console.log('üîç DEBUG: data.preset exists?', !!data.preset);
            console.log('üîç DEBUG: data.config exists?', !!data.config); // Legacy debug - data.config deprecated
            if (data.preset) {
                console.log('üîç DEBUG: data.preset.future_appointments_weight:', data.preset.future_appointments_weight);
                console.log('üîç DEBUG: data.preset.open_dna_invoice_weight:', data.preset.open_dna_invoice_weight);
            
            }
            
            // Update all slider values from the response
            if (data.preset) {
                // Update weight sliders
                // FIXED: Use correct approach - simple vs complex sliders
                const simpleSliders = [
                    {field: 'future_appointments_weight', sliderName: 'future_appointments_weight'},
                    {field: 'age_demographics_weight', sliderName: 'age_demographics_weight'},
                    {field: 'yearly_spend_weight', sliderName: 'yearly_spend_weight'},
                    {field: 'consecutive_attendance_weight', sliderName: 'consecutive_attendance_weight'}
                ];
                
                const complexSliders = [
                    {field: 'cancellations_weight', displayId: 'cancellations_weight_value'},
                    {field: 'dna_weight', displayId: 'dna_weight_value'},
                    {field: 'unpaid_invoices_weight', displayId: 'unpaid_invoices_weight_value'},
                    {field: 'open_dna_invoice_weight', displayId: 'open_dna_invoice_weight_value'}
                ];
                
                // Update points fields
                const points = {
                    'points-per-consecutive-attendance': data.preset.points_per_consecutive_attendance,
                    'points-per-cancellation': data.preset.points_per_cancellation,
                    'points-per-dna': data.preset.points_per_dna,
                    'points-per-unpaid-invoice': data.preset.points_per_unpaid_invoice
                };
                
                // FIXED: Handle simple and complex sliders differently
                
                // Update simple sliders (first 4) - just update slider value, display updates automatically
                simpleSliders.forEach(mapping => {
                    const slider = document.querySelector(`input[name='${mapping.sliderName}']`);
                    const value = data.preset[mapping.field];
                    
                    if (slider && value !== undefined) {
                        slider.value = value;
                        // Trigger the oninput event to update display
                        slider.dispatchEvent(new Event('input'));
                        console.log(`‚úÖ Updated simple slider ${mapping.field}: ${value}`);
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.warn(`‚ùå Failed to update simple slider ${mapping.field}:`, {slider: !!slider, value});
                    }
                });
                
                // Update complex sliders (last 4) - update both slider and display element
                complexSliders.forEach(mapping => {
                    const slider = document.querySelector(`input[name='${mapping.field}']`);
                    const display = document.getElementById(mapping.displayId);
                    const value = data.preset[mapping.field];
                    
                    if (slider && display && value !== undefined) {
                        slider.value = value;
                        display.textContent = value;
                        console.log(`‚úÖ Updated complex slider ${mapping.field}: ${value}`);
                            
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                        console.warn(`‚ùå Failed to update complex slider ${mapping.field}:`, {slider: !!slider, display: !!display, value});
                    }
                });
                
                // Apply points values
                Object.entries(points).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = value;
                    }
                });
                
                console.log('All slider and points values updated from preset:', presetName);
            }
                
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
            console.error('Failed to apply preset:', data.error);
        }
    })
    .catch(error => {
        console.error('Error applying preset:', error);
    });
    

}

// Function to show inline success message (like Update Preset success)
function showInlineSuccessMessage(message) {
    console.log('Showing inline success message:', message);
    
    // Find the update button to show success message next to it
    const updateButton = document.getElementById('update-preset-btn');
    if (updateButton) {
        // Remove any existing success messages
        const existingSuccess = updateButton.parentElement.querySelector('.success-message');
        if (existingSuccess) {
            existingSuccess.remove();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const appliedPresetName = null; // localStorage persistence disabled
            if (appliedPresetName) {
                updatePresetHeader(appliedPresetName);
                console.log('Restored header to show applied preset:', appliedPresetName);
            }
            
            // Screen values loaded from database via Django template (localStorage persistence removed)
            // const persistenceData = null; // localStorage persistence disabled
            if (false) {
                try {
                    const data = null; // localStorage persistence disabled
                    console.log('Restoring comprehensive persistence data:', data);
                    
                    // Restore all 8 slider values
                    if (data.sliders) {
                        Object.keys(data.sliders).forEach(sliderName => {
                            const slider = document.querySelector('input[name="' + sliderName + '"]');
                            // Try pattern without _weight first (for first 4 sliders)
                            let valueDisplay = document.getElementById(sliderName.replace('_weight', '') + '_value');
                            // If not found, try pattern with _weight (for last 4 sliders)  
                            if (!valueDisplay) {
                                valueDisplay = document.getElementById(sliderName + '_value');
                            }
                            if (slider && data.sliders[sliderName]) {
                                slider.value = data.sliders[sliderName];
                                if (valueDisplay) {
                                    valueDisplay.textContent = data.sliders[sliderName];
                                }
                                console.log('Restored slider:', sliderName, '=', data.sliders[sliderName]);
                            }
                        });
                    }
                    
                    // Restore all 4 points display values
                    if (data.points) {
                        Object.keys(data.points).forEach(pointsId => {
                            const display = document.getElementById(pointsId);
                            const inputId = pointsId.replace('-points-display', '-input');
                            const hiddenId = pointsId.replace('-points-display', '-hidden');
                            const input = document.getElementById(inputId);
                            const hidden = document.getElementById(hiddenId);
                            
                            if (display && data.points[pointsId]) {
                                display.textContent = data.points[pointsId];
                                if (input) input.value = data.points[pointsId];
                                if (hidden) hidden.value = data.points[pointsId];
                                console.log('Restored points:', pointsId, '=', data.points[pointsId]);
                            }
                        });
                    }
                    
                    // Restore age brackets
                    if (data.ageBrackets && data.ageBrackets.length > 0) {
                        const ageBracketsContainer = document.getElementById('age-brackets-content');
                        if (ageBracketsContainer) {
                            // Clear existing brackets (keep only the + ADD button)
                            const addButton = ageBracketsContainer.querySelector('button[onclick*="addNewAgeBracket"]');
                            ageBracketsContainer.innerHTML = '';
                            
                            // Create container div
                            const containerDiv = document.createElement('div');
                            containerDiv.style.cssText = 'display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap;';
                            
                            // Add restored brackets with complete structure including delete buttons
                            data.ageBrackets.forEach(bracketText => {
                                const bracketDiv = document.createElement('div');
                                bracketDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
                                
                                // Parse bracket text (e.g., "18-25 20%")
                                const parts = bracketText.trim().split(/\s+/);
                                const rangeText = parts[0]; // "18-25"
                                const percentageText = parts[parts.length - 1]; // "20%"
                                
                                bracketDiv.innerHTML = '<div style="display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;"><div style="padding: 4px 8px; border-right: 1px solid #dee2e6; font-weight: 500;">' + rangeText + '</div><div style="padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;">' + percentageText + '</div></div><div style="display: flex; gap: 4px; margin-top: 2px;"><button onclick="deleteAgeBracket(\'restored-\' + Math.random().toString(36).substr(2, 9))" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Delete</button></div>';
                                containerDiv.appendChild(bracketDiv);
                            });
                            
                            // Re-add the + ADD button
                            if (addButton) {
                                containerDiv.appendChild(addButton);
                            }
                            
                            ageBracketsContainer.appendChild(containerDiv);
                            console.log('Restored age brackets:', data.ageBrackets.length, 'brackets');
                        }
                    }
                    
                    // Restore spend brackets
                    if (data.spendBrackets && data.spendBrackets.length > 0) {
                        const spendBracketsContainer = document.getElementById('spend-brackets-content');
                        if (spendBracketsContainer) {
                            // Clear existing brackets (keep only the + ADD button)
                            const addButton = spendBracketsContainer.querySelector('button[onclick*="addNewSpendBracket"]');
                            spendBracketsContainer.innerHTML = '';
                            
                            // Create container div
                            const containerDiv = document.createElement('div');
                            containerDiv.style.cssText = 'display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap;';
                            
                            // Add restored brackets with complete structure including delete buttons
                            data.spendBrackets.forEach(bracketText => {
                                const bracketDiv = document.createElement('div');
                                bracketDiv.style.cssText = 'display: flex; flex-direction: column; align-items: flex-start;';
                                
                                // Parse bracket text (e.g., "0-500 15%")
                                const parts = bracketText.trim().split(/\s+/);
                                const rangeText = parts[0]; // "0-500"
                                const percentageText = parts[parts.length - 1]; // "15%"
                                
                                bracketDiv.innerHTML = '<div style="display: flex; border: 1px solid #dee2e6; border-radius: 3px; background: white; font-size: 0.8rem;"><div style="padding: 4px 12px; border-right: 1px solid #dee2e6; font-weight: 500; min-width: 85px; text-align: center;">' + rangeText + '</div><div style="padding: 4px 8px; background: #f8f9fa; font-weight: 600; color: #007bff;">' + percentageText + '</div></div><div style="display: flex; gap: 4px; margin-top: 2px;"><button onclick="deleteSpendBracket(\'restored-\' + Math.random().toString(36).substr(2, 9))" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; cursor: pointer;">Delete</button></div>';
                                containerDiv.appendChild(bracketDiv);
                            });
                            
                            // Re-add the + ADD button
                            if (addButton) {
                                containerDiv.appendChild(addButton);
                            }
                            
                            spendBracketsContainer.appendChild(containerDiv);
                            console.log('Restored spend brackets:', data.spendBrackets.length, 'brackets');
                        }
                    }
                    
                    console.log('Complete persistence restoration finished');
                    
                } catch (error) {
                    console.error('Error restoring persistence data:', error);
                }
                    
                // All slider updates completed successfully
                console.log('applyPresetById completed for preset ID:');
            } else {
                console.log('No persistence data found in localStorage');
            }
        });
// Make bracket functions globally accessible
window.addNewAgeBracket = addNewAgeBracket;
window.addNewSpendBracket = addNewSpendBracket;
window.deleteAgeBracket = deleteAgeBracket;
window.deleteSpendBracket = deleteSpendBracket;
}
    }

// ===========================================
// PATIENT CARDS JAVASCRIPT FUNCTIONS
// ===========================================

// Global variable to store current patient ID
window.currentPatientId = null;

// Search Patients Function
function searchPatients() {
    const searchTerm = document.getElementById('patient-search-input').value.trim();
    if (searchTerm.length < 2) {
        alert('Please enter at least 2 characters to search');
        return;
    }
    
    // Show loading state
    const searchBtn = document.getElementById('search-patient-btn');
    const originalText = searchBtn.textContent;
    searchBtn.textContent = 'Searching...';
    searchBtn.disabled = true;
    
    // AJAX search request
    fetch('/patients/dashboard/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `action=search_patients&search_term=${encodeURIComponent(searchTerm)}`
    })
    .then(response => response.json())
    .then(data => {
        displaySearchResults(data.patients || []);
        searchBtn.textContent = originalText;
        searchBtn.disabled = false;
    })
    .catch(error => {
        console.error('Search error:', error);
        searchBtn.textContent = originalText;
        searchBtn.disabled = false;
        alert('Search failed. Please try again.');
    });
}

// Display Search Results Function
function displaySearchResults(patients) {
    const resultsContainer = document.getElementById('search-results-container');
    const resultsList = document.getElementById('search-results-list');
    const resultsCount = document.getElementById('results-count');
    
    resultsCount.textContent = patients.length;
    
    if (patients.length === 0) {
        resultsList.innerHTML = '<div style="padding: 12px; text-align: center; color: #666; font-size: 0.85rem;">No patients found</div>';
    } else {
        resultsList.innerHTML = patients.map(patient => `
            <div class="search-result-item" style="padding: 8px 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 0.85rem;" 
                 onclick="selectPatient(${patient.id}, '${patient.name.replace(/'/g, "\'")}')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 500;">${patient.name}</span>
                    <span style="color: #666; font-size: 0.75rem;">ID: ${patient.id}</span>
                </div>
            </div>
        `).join('');
    }
    
    resultsContainer.style.display = 'block';
}

// Select Patient Function
function selectPatient(patientId, patientName) {
    // Update selected patient header
    document.getElementById('selected-patient-name').textContent = patientName;
    document.getElementById('selected-patient-id').textContent = `ID: ${patientId}`;
    document.getElementById('selected-patient-header').style.display = 'block';
    
    // Hide search results
    document.getElementById('search-results-container').style.display = 'none';
    
    // Show behavior cards container
    document.getElementById('behavior-cards-container').style.display = 'block';
    
    // Store current patient ID
    window.currentPatientId = patientId;
    
    // Load patient behavior data
    loadPatientBehaviorData(patientId);
    
    // Load behavior data for all cards when patient is selected
    console.log('Loading behavior data for patient:', patientId);
    loadPatientBehaviorData(patientId);
}

// Load Patient Behavior Data Function
function loadPatientBehaviorData(patientId) {
    // AJAX request to load patient data
    fetch('/patients/dashboard/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `action=load_patient_data&patient_id=${patientId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update sliders with patient data
            updateLikabilitySlider(data.likability || 50);
            // updateUnlikabilitySlider removed - field no longer exists
        }
    })
    .catch(error => {
        console.error('Load patient data error:', error);
    });
}

// Update Likability Slider
function updateLikabilitySlider(value) {
    document.getElementById('likability-slider').value = value;
    document.getElementById('likability-value').textContent = value;
}

// Update Unlikability Slider  
function updateUnlikabilitySlider(value) {
    document.getElementById('unlikability-slider').value = value;
    document.getElementById('unlikability-value').textContent = value;
}

// Likability Edit/Save Functions
function editLikability() {
    document.getElementById('likability-slider').disabled = false;
    document.getElementById('edit-likability-btn').style.display = 'none';
    document.getElementById('save-likability-btn').style.display = 'inline-block';
}

function saveLikability() {
    const value = document.getElementById('likability-slider').value;
    const patientId = window.currentPatientId;
    
    if (!patientId) {
        alert('No patient selected');
        return;
    }
    
    fetch('/patients/dashboard/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `action=update_likability&patient_id=${patientId}&likability=${value}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('likability-slider').disabled = true;
            document.getElementById('edit-likability-btn').style.display = 'inline-block';
            document.getElementById('save-likability-btn').style.display = 'none';
            document.getElementById('likability-value').textContent = value;
        }
    })
    .catch(error => {
        console.error('Likability save error:', error);
    });
}



// Update slider values when sliders are moved
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for slider value updates
    const likabilitySlider = document.getElementById('likability-slider');
    const unlikabilitySlider = document.getElementById('unlikability-slider');
    
    if (likabilitySlider) {
        likabilitySlider.addEventListener('input', function() {
            document.getElementById('likability-value').textContent = this.value;
        });
    }
    
    if (unlikabilitySlider) {
        unlikabilitySlider.addEventListener('input', function() {
            document.getElementById('unlikability-value').textContent = this.value;
        });
    }
});

// ===========================================
// END PATIENT CARDS JAVASCRIPT FUNCTIONS
// ===========================================


// Open DNA Invoice Card Integration
function loadPatientBehaviorData(patientId) {
    if (!patientId) {
        console.log('No patient ID provided');
        return;
    }
    
    // Show loading state
    const dnaCard = document.querySelector('.compact-behavior-card:has([style*="üìã Open DNA Invoices"])');
    if (dnaCard) {
        dnaCard.style.opacity = '0.6';
    }
    
    // Make AJAX request to load patient behavior data
    fetch('/patients/dashboard/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `action=load_patient_behavior&patient_id=${patientId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.behavior_data) {
            updateOpenDnaInvoiceCard(data.behavior_data.open_dna_invoice);
            updateLikabilityCard(data.behavior_data.likability);
        } else {
            console.error('Failed to load behavior data:', data.error);
        }
    })
    .catch(error => {
        console.error('Error loading patient behavior:', error);
    })
    .finally(() => {
        // Remove loading state
        if (dnaCard) {
            dnaCard.style.opacity = '1';
        }
    });
}

function updateOpenDnaInvoiceCard(dnaData) {
    // Find the Open DNA Invoice card elements
    const descriptionSpan = document.querySelector('span[style*="color: #666"]');
    // const pointsSpan = document.querySelector('span[style*="color: #dc3545"]:has-text("0")'); // REMOVED: Invalid :has-text() selector
    
    // Alternative selector approach
    const allSpans = document.querySelectorAll('span');
    let descElement = null;
    let pointsElement = null;
    
    for (let span of allSpans) {
        if (span.textContent && span.textContent.includes('open DNA invoices')) {
            descElement = span;
        }
        if (span.style.color === 'rgb(220, 53, 69)' && span.textContent === '0') {
            pointsElement = span;
        }
    }
    
    // Update description
    if (descElement) {
        descElement.textContent = dnaData.description;
        console.log('Updated DNA description:', dnaData.description);
    }
    
    // Update points
    if (pointsElement) {
        pointsElement.textContent = Math.abs(dnaData.points).toString();
        console.log('Updated DNA points:', dnaData.points);
    }
    
    console.log('Open DNA Invoice card updated:', dnaData);
}

function updateLikabilityCard(likabilityData) {
    // Update the likability slider with real patient data
    const likabilitySlider = document.getElementById('likability-slider');
    const likabilityValue = document.getElementById('likability-value');
    
    if (likabilitySlider && likabilityValue) {
        // Update slider value and display
        likabilitySlider.value = likabilityData.score;
        likabilityValue.textContent = likabilityData.score;
        
        // Update slider visual state based on score
        likabilitySlider.className = 'likability-slider';
        if (likabilityData.is_positive) {
            likabilitySlider.classList.add('positive');
        } else if (likabilityData.is_negative) {
            likabilitySlider.classList.add('negative');
        } else {
            likabilitySlider.classList.add('neutral');
        }
        
        console.log('Likability card updated:', {
            score: likabilityData.score,
            description: likabilityData.description,
            status: likabilityData.status
        });
    } else {
        console.error('Likability slider elements not found');
    }
}


// Hook into existing patient search functionality
// This will be called when a patient is selected
function onPatientSelected(patientId) {
    console.log('Patient selected:', patientId);
    loadPatientBehaviorData(patientId);
}

    </script>
</body>
</html>
