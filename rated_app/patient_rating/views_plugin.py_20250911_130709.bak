import json
from django.shortcuts import render, redirect, get_object_or_404
from django.http import JsonResponse, HttpResponseRedirect
from django.views.decorators.http import require_POST, require_http_methods
from django.views import View
from django.contrib import messages
from django.urls import reverse
from django.db.models import F
from django.db import models, IntegrityError, transaction
from django.views.decorators.csrf import csrf_exempt

# Plugin System Imports
from sintra.integrations.base import BaseIntegrationClient
from sintra.integrations.feature_flags import feature_flag

# Local Plugin Imports
from .integrations.factory import IntegrationFactory
from .behavioral_processor import BehavioralProcessor

# Model Imports
from .models import (
    ScoringConfiguration, 
    Patient, 
    AgeBracket, 
    SpendBracket, 
    RatedAppSettings
)

# Utility Imports
import logging
import requests
import base64
import pytz
from datetime import datetime

# Configure logging
logger = logging.getLogger('ratedapp.views_plugin')

# Feature Flag Configuration
PLUGIN_MIGRATION_ENABLED = feature_flag('ratedapp_patient_rating_migration', default=False)

# Plugin System Helper Functions
def get_integration_client():
    """
    Get the appropriate integration client based on settings
    Uses plugin system factory pattern
    """
    try:
        settings = RatedAppSettings.objects.first()
        if not settings:
            logger.error("No RatedApp settings found")
            return None
        
        # Use plugin system if enabled, fallback to legacy
        if getattr(settings, 'use_plugin_system', False) or PLUGIN_MIGRATION_ENABLED:
            client = IntegrationFactory.get_client(settings)
            normalizer = IntegrationFactory.get_normalizer(settings)
            return client, normalizer
        else:
            # Legacy fallback - maintain existing functionality
            return None, None
            
    except Exception as e:
        logger.error(f"Error getting integration client: {e}")
        return None, None

def safe_int(value, default=0):
    """
    Safely convert a value to integer, returning default if conversion fails.
    Handles None, empty strings, and invalid values gracefully.
    """
    if value is None or value == '':
        return default
    try:
        return int(float(str(value).strip()))
    except (ValueError, TypeError):
        return default

def get_referrer_count_plugin(patient_id, client):
    """
    Get referrer count using plugin system
    Replaces hardcoded Cliniko API calls
    """
    try:
        if client:
            referrals = client.get_referrals(patient_id)
            if isinstance(referrals, dict):
                return referrals.get('referral_count', 0)
            return len(referrals) if referrals else 0
        return 0
    except Exception as e:
        logger.error(f"Error getting referrer count for patient {patient_id}: {e}")
        return 0

def calculate_referrer_score_plugin(patient_id, points_per_referral, max_points, client):
    """
    Calculate referrer score using plugin system
    Maintains same logic as original but uses plugin architecture
    """
    referral_count = get_referrer_count_plugin(patient_id, client)
    raw_score = referral_count * points_per_referral
    final_score = min(raw_score, max_points)
    
    logger.info(f"Referrer score for patient {patient_id}: {referral_count} referrals Ã— {points_per_referral} points = {raw_score}, capped at {max_points} = {final_score}")
    
    return final_score

